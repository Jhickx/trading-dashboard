<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ============================================================
   CSS VARIABLES - Design System
   ============================================================ */
:root {
  /* Colors */
  --color-bg-dark: hsl(0, 0%, 0%);
  --color-bg: hsl(0, 0%, 5%);
  --color-bg-light: hsl(0, 0%, 10%);
  --color-border: hsl(0, 0%, 10%);
  --color-border-light: hsl(0, 0%, 20%);
  --color-text: hsl(0, 0%, 95%);
  --color-text-light: hsl(0, 0%, 75%);
  --color-text-muted: hsl(0, 0%, 55%);
  --color-green: #00c9a7;
  --color-red: #ff4757;
  --color-accent: #00c9a7;
  
  /* Gradients */
  --gradient-card: linear-gradient(0deg, var(--color-bg) 95%, var(--color-bg-light));
  --gradient-card-hover: linear-gradient(0deg, var(--color-bg), var(--color-bg-light));
  
  /* Typography */
  --ff: "Manrope", sans-serif;
  --h1: 700 1.6rem/1em var(--ff);
  --h2: 700 1.4rem/1em var(--ff);
  --h3: 700 1.2rem/1em var(--ff);
  --p: 400 1rem/1em var(--ff);
  --small: 400 0.8rem/1em var(--ff);
  
  /* Spacing */
  --rounded: 0.75rem;
  --spacing-xs: 0.5rem;
  --spacing-sm: 1rem;
  --spacing-md: 1.5rem;
  --spacing-lg: 2rem;
  --spacing-xl: 3rem;
  
  /* Card padding - CONSISTENT across all cards */
  --card-padding: 1.5rem;
  
  /* Shadows */
  --shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
}

/* ============================================================
   RESET & BASE
   ============================================================ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--ff);
  font: var(--p);
  background: var(--color-bg-dark);
  color: var(--color-text);
  margin: 0 auto;
  width: 95%;
  max-width: 1400px;
  padding: var(--spacing-md) 0;
}

h1, h2, h3, h4, p { margin: 0; padding: 0; }
h1 { font: var(--h1); }
h2 { font: var(--h2); }
h3 { font: var(--h3); color: var(--color-text); }

/* ============================================================
   UTILITY CLASSES
   ============================================================ */
.shine {
  background: var(--gradient-card);
  border: solid 1px var(--color-border);
  border-top: 1px solid var(--color-border-light);
  box-shadow: var(--shadow);
  border-radius: var(--rounded);
  transition: background 0.2s ease;
}

.shine:hover {
  background: var(--gradient-card-hover);
}

/* ============================================================
   HEADER
   ============================================================ */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-lg);
}

.header h1 {
  font-size: 1.4rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.header-subtitle {
  color: var(--color-text-light);
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

.date-filter {
  display: flex;
  gap: var(--spacing-xs);
  align-items: center;
}

.date-filter input {
  background: var(--color-bg-light);
  border: 1px solid var(--color-border);
  color: var(--color-text);
  padding: 0.5rem 0.75rem;
  border-radius: var(--rounded);
  font-family: var(--ff);
  font-size: 0.75rem;
  outline: none;
}

.date-filter input:focus {
  border-color: var(--color-accent);
}

.date-filter button {
  background: var(--color-accent);
  color: var(--color-bg-dark);
  border: none;
  padding: 0.5rem 1rem;
  border-radius: var(--rounded);
  font-family: var(--ff);
  font-weight: 600;
  font-size: 0.75rem;
  cursor: pointer;
  transition: opacity 0.2s;
}

.date-filter button:hover {
  opacity: 0.85;
}

.date-filter span {
  color: var(--color-text-muted);
  font-size: 0.875rem;
}

/* ============================================================
   STATUS BAR
   ============================================================ */
.status-bar {
  display: flex;
  gap: var(--spacing-sm);
  align-items: center;
  margin-bottom: var(--spacing-lg);
  color: var(--color-text-muted);
  font-size: 0.75rem;
}

.status-success {
  color: var(--color-green);
}

/* ============================================================
   METRICS GRID
   ============================================================ */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-lg);
}

.metric-card {
  padding: var(--card-padding);
  position: relative;
}

.metric-label {
  font-size: 0.75rem;
  color: var(--color-text-light);
  font-weight: 500;
  margin-bottom: var(--spacing-xs);
}

.metric-value {
  font-size: 1.25rem;
  font-weight: 700;
  letter-spacing: -0.5px;
  color: var(--color-text);
}

.metric-value.positive { color: var(--color-green); }
.metric-value.negative { color: var(--color-red); }

/* ============================================================
   GAUGE COMPONENTS
   ============================================================ */
.gauge-container {
  position: absolute;
  top: var(--card-padding);
  right: var(--card-padding);
  display: flex;
  flex-direction: column;
  align-items: center;
}

.gauge-stats {
  display: flex;
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.gauge-stat {
  text-align: center;
  font-size: 0.75rem;
}

.gauge-stat-value {
  font-weight: 600;
  font-size: 0.8125rem;
}

.gauge-stat.win .gauge-stat-value { color: var(--color-green); }
.gauge-stat.loss .gauge-stat-value { color: var(--color-red); }
.gauge-stat.neutral .gauge-stat-value { color: var(--color-text-muted); }

/* Avg Win/Loss Bar */
.avg-container {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin-top: 0.5rem;
}

.avg-bar-wrapper {
  flex: 1;
  min-width: 100px;
}

.avg-bar {
  display: flex;
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
  gap: 3px;
  margin-bottom: 0.5rem;
}

.avg-bar-part-win {
  background: var(--color-green);
  flex: 1;
  border-radius: 3px;
}

.avg-bar-part-loss {
  background: var(--color-red);
  flex: 1;
  border-radius: 3px;
}

.avg-bar-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.625rem;
  color: var(--color-text-muted);
}

.avg-bar-labels .win { color: var(--color-green); }
.avg-bar-labels .loss { color: var(--color-red); }

/* ============================================================
   CHARTS
   ============================================================ */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(400px, 100%), 1fr));
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-lg);
}

.chart-card {
  padding: var(--card-padding);
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.chart-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--color-text-light);
}

.chart-canvas {
  width: 100% !important;
  height: 200px !important;
}

/* ============================================================
   CALENDAR
   ============================================================ */
.calendar-section {
  margin-bottom: var(--spacing-lg);
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-sm);
}

.calendar-nav {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.calendar-nav button {
  background: none;
  border: none;
  color: var(--color-text-muted);
  cursor: pointer;
  padding: 0.25rem;
  font-size: 1.25rem;
}

.calendar-nav button:hover {
  color: var(--color-text);
}

.calendar-month {
  font-size: 1rem;
  font-weight: 600;
}

.calendar-stats {
  text-align: right;
  font-size: 0.75rem;
}

.calendar-stats-pnl {
  font-weight: 600;
  font-size: 0.875rem;
}

.calendar-stats-pnl.positive { color: var(--color-green); }
.calendar-stats-pnl.negative { color: var(--color-red); }

.calendar-stats-days {
  color: var(--color-text-muted);
}

.calendar-wrapper {
  display: flex;
  gap: var(--spacing-sm);
}

.calendar-grid-container {
  flex: 1;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.calendar-day-header {
  font-size: 0.6875rem;
  color: var(--color-text-muted);
  text-align: center;
  padding: var(--spacing-xs) 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.calendar-day {
  background: var(--color-bg-light);
  border-radius: var(--rounded);
  padding: var(--spacing-xs);
  height: 90px;
  position: relative;
  border: 1px solid transparent;
  overflow: hidden;
}

.calendar-day.positive {
  background: rgba(0, 201, 167, 0.08);
  border-color: rgba(0, 201, 167, 0.2);
}

.calendar-day.negative {
  background: rgba(255, 71, 87, 0.08);
  border-color: rgba(255, 71, 87, 0.2);
}

.calendar-day-num {
  font-size: 0.6875rem;
  color: var(--color-text-muted);
  margin-bottom: 4px;
  text-align: right;
}

.calendar-day.today .calendar-day-num {
  color: #ffffff;
  font-weight: 500;
  background: #e64848;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  float: right;
  clear: both;
}

.calendar-day.today .calendar-day-pnl {
  clear: both;
}

.calendar-day-pnl {
  font-size: 0.75rem;
  font-weight: 600;
  margin-bottom: 2px;
}

.calendar-day-pnl.positive { color: var(--color-green); }
.calendar-day-pnl.negative { color: var(--color-red); }

.calendar-day-meta {
  font-size: 0.625rem;
  color: var(--color-text-muted);
  margin-top: 2px;
  line-height: 1.4;
}

/* Weekly Sidebar */
.weekly-sidebar {
  width: 120px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-top: 27px;
}

.week-item {
  background: var(--color-bg-light);
  border-radius: var(--rounded);
  padding: var(--spacing-xs);
  height: 90px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center;
}

.week-label {
  font-size: 0.6875rem;
  color: var(--color-text-muted);
  margin-bottom: 3px;
}

.week-pnl {
  font-weight: 600;
  font-size: 0.8125rem;
}

.week-pnl.positive { color: var(--color-green); }
.week-pnl.negative { color: var(--color-red); }

.week-days {
  font-size: 0.625rem;
  color: var(--color-text-muted);
  margin-top: 2px;
}

/* ============================================================
   RESPONSIVE DESIGN
   ============================================================ */
@media (max-width: 1024px) {
  body {
    padding: var(--spacing-md) 0;
  }
  
  .metrics-grid {
    grid-template-columns: repeat(auto-fit, minmax(min(220px, 100%), 1fr));
  }
}

@media (max-width: 768px) {
  body {
    padding: var(--spacing-sm) 0;
  }
  
  .header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }
  
  .date-filter {
    width: 100%;
  }
  
  .metrics-grid {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .calendar-wrapper {
    flex-direction: column;
  }
  
  .weekly-sidebar {
    flex-direction: row;
    width: 100%;
    margin-top: var(--spacing-sm);
  }
  
  .week-item {
    flex: 1;
  }
}

@media (max-width: 480px) {
  body {
    width: 100%;
    padding: var(--spacing-sm);
  }
  
  .metric-card,
  .chart-card {
    padding: var(--spacing-sm);
  }
  
  .metric-value {
    font-size: 1.125rem;
  }
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div>
    <h1>Trading Dashboard</h1>
    <div class="header-subtitle">Performance overview & analytics</div>
  </div>
  <div class="date-filter">
    <input type="date" id="dateFrom" />
    <span>to</span>
    <input type="date" id="dateTo" />
    <button onclick="applyDateFilter()">Apply</button>
  </div>
</div>

<!-- Status Bar -->
<div class="status-bar">
  <span id="statusLoading">Loading trade data...</span>
  <span id="statusSuccess" class="status-success" style="display:none;">✓ Data loaded</span>
</div>

<!-- Metrics Grid -->
<div class="metrics-grid">
  <!-- Net P&L -->
  <div class="metric-card shine">
    <div class="metric-label">Net P&L</div>
    <div class="metric-value" id="val-pnl">—</div>
  </div>
  
  <!-- Trade Win % -->
  <div class="metric-card shine" style="position:relative; padding-right:110px;">
    <div class="gauge-container">
      <svg viewBox="0 0 80 50" style="width:70px; height:44px;">
        <path d="M 10 45 A 30 30 0 0 1 70 45" fill="none" stroke="hsl(0,0%,10%)" stroke-width="6" stroke-linecap="round"/>
        <path d="M 10 45 A 30 30 0 0 1 70 45" fill="none" stroke="#ff4757" stroke-width="6" stroke-linecap="round" id="gauge-arc-loss" stroke-dasharray="94.25" stroke-dashoffset="0"/>
        <path d="M 10 45 A 30 30 0 0 1 70 45" fill="none" stroke="#00c9a7" stroke-width="6" stroke-linecap="round" id="gauge-arc" stroke-dasharray="94.25" stroke-dashoffset="94.25"/>
      </svg>
      <div class="gauge-stats">
        <div class="gauge-stat win">
          <div class="gauge-stat-value" id="val-wins">0</div>
        </div>
        <div class="gauge-stat neutral">
          <div class="gauge-stat-value" id="val-breakeven">0</div>
        </div>
        <div class="gauge-stat loss">
          <div class="gauge-stat-value" id="val-losses">0</div>
        </div>
      </div>
    </div>
    <div class="metric-label">Trade win %</div>
    <div class="metric-value" id="val-winrate">—</div>
  </div>
  
  <!-- Profit Factor -->
  <div class="metric-card shine" style="position:relative;">
    <svg viewBox="0 0 64 64" style="position:absolute; top:1.5rem; right:1.5rem; width:64px; height:64px;">
      <circle cx="32" cy="32" r="26" fill="none" stroke="hsl(0,0%,10%)" stroke-width="6" stroke-linecap="round" stroke-dasharray="163.36" stroke-dashoffset="0" transform="rotate(-90 32 32)"/>
      <circle cx="32" cy="32" r="26" fill="none" stroke="#00c9a7" stroke-width="6" stroke-linecap="round" stroke-dasharray="163.36" stroke-dashoffset="163.36" id="pf-gauge-circle" transform="rotate(-90 32 32)"/>
    </svg>
    <div class="metric-label">Profit factor</div>
    <div class="metric-value" id="val-pf">—</div>
  </div>
  
  <!-- Avg Win / Loss -->
  <div class="metric-card shine">
    <div class="metric-label">Avg win / loss trade</div>
    <div class="avg-container">
      <div class="metric-value" id="val-ratio" style="font-size:1rem; white-space:nowrap;">—</div>
      <div class="avg-bar-wrapper">
        <div class="avg-bar">
          <div class="avg-bar-part-win" id="avg-bar-win"></div>
          <div class="avg-bar-part-loss" id="avg-bar-loss"></div>
        </div>
        <div class="avg-bar-labels">
          <span class="win" id="label-avgwin">—</span>
          <span class="loss" id="label-avgloss">—</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Grid -->
<div class="charts-grid">
  <!-- Cumulative P&L Chart -->
  <div class="chart-card shine">
    <div class="chart-header">
      <div class="chart-title">Daily net cumulative P&L</div>
    </div>
    <canvas id="cumulativeChart" class="chart-canvas"></canvas>
  </div>
  
  <!-- Daily P&L Chart -->
  <div class="chart-card shine">
    <div class="chart-header">
      <div class="chart-title">Net daily P&L</div>
    </div>
    <canvas id="dailyChart" class="chart-canvas"></canvas>
  </div>
</div>

<!-- Calendar Section -->
<div class="calendar-section">
  <div class="calendar-header">
    <div class="calendar-nav">
      <button onclick="changeMonth(-1)">←</button>
      <div class="calendar-month" id="calendarMonth">February 2026</div>
      <button onclick="changeMonth(1)">→</button>
      <button onclick="goToCurrentMonth()" style="margin-left:0.5rem; padding:0.25rem 0.75rem; background:var(--color-bg-light); border-radius:var(--rounded); font-size:0.75rem;">This month</button>
    </div>
    <div class="calendar-stats">
      <div class="calendar-stats-pnl" id="monthlyPnl">$0.00</div>
      <div class="calendar-stats-days" id="monthlyDays">0 days</div>
    </div>
  </div>
  
  <div class="calendar-wrapper">
    <div class="calendar-grid-container">
      <div class="calendar-grid">
        <div class="calendar-day-header">Mon</div>
        <div class="calendar-day-header">Tue</div>
        <div class="calendar-day-header">Wed</div>
        <div class="calendar-day-header">Thu</div>
        <div class="calendar-day-header">Fri</div>
        <div class="calendar-day-header">Sat</div>
        <div class="calendar-day-header">Sun</div>
      </div>
      <div class="calendar-grid" id="calendarGrid"></div>
    </div>
    <div class="weekly-sidebar" id="weeklySidebar"></div>
  </div>
</div>

<script>
// ============================================================
// GLOBAL STATE
// ============================================================
let allTrades = [];
let allTradesUnfiltered = [];
let dailyData = {};
let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();
let cumulativeChart = null;
let dailyChart = null;
let dateFilterFrom = null;
let dateFilterTo = null;

const PUB_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH3jFflZ0yd3k_owNsVgezKK00Z8HGehudo_5gqajVxvCqMCeCCwSwkDhx9484DVHY3z9hWMds2ime/pub?gid=653744386&single=true&output=csv';
const GVIZ_URL = 'https://docs.google.com/spreadsheets/d/1lr6NH8wkv0lZvuriRLG2nCSlg-VGH6D6JA5sxDE7Bus/gviz/tq?tqx=out:csv&gid=653744386';

// ============================================================
// DATE FILTER
// ============================================================
function applyDateFilter() {
  const fromInput = document.getElementById('dateFrom').value;
  const toInput = document.getElementById('dateTo').value;
  
  dateFilterFrom = fromInput ? new Date(fromInput + 'T00:00:00') : null;
  dateFilterTo = toInput ? new Date(toInput + 'T23:59:59') : null;
  
  if (dateFilterFrom || dateFilterTo) {
    allTrades = allTradesUnfiltered.filter(t => {
      if (dateFilterFrom && t.date < dateFilterFrom) return false;
      if (dateFilterTo && t.date > dateFilterTo) return false;
      return true;
    });
  } else {
    allTrades = [...allTradesUnfiltered];
  }
  
  dailyData = {};
  allTrades.forEach(t => {
    if (!dailyData[t.dateKey]) {
      dailyData[t.dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[t.dateKey].pnl += t.pnl;
    dailyData[t.dateKey].tradeCount += 1;
    if (t.pnl > 0) dailyData[t.dateKey].wins += 1;
    else if (t.pnl < 0) dailyData[t.dateKey].losses += 1;
    else dailyData[t.dateKey].breakeven += 1;
  });
  
  renderAll();
}

// ============================================================
// LOAD DATA
// ============================================================
async function loadData() {
  const statusLoading = document.getElementById('statusLoading');
  const statusSuccess = document.getElementById('statusSuccess');

  const urls = [PUB_URL, GVIZ_URL];

  for (const url of urls) {
    try {
      const res = await fetch(url);
      if (!res.ok) continue;
      const text = await res.text();
      if (text.length < 100) continue;
      
      if (cumulativeChart) { cumulativeChart.destroy(); cumulativeChart = null; }
      if (dailyChart) { dailyChart.destroy(); dailyChart = null; }
      
      parseCSV(text);
      renderAll();
      
      statusLoading.style.display = 'none';
      statusSuccess.style.display = 'inline';
      return;
    } catch(e) {
      continue;
    }
  }

  statusLoading.textContent = '⚠ Failed to load data';
  statusLoading.style.color = 'var(--color-red)';
}

// ============================================================
// CSV PARSER
// ============================================================
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current.trim());
  return result;
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]);
  allTrades = [];
  allTradesUnfiltered = [];
  dailyData = {};

  const dateIdx = headers.findIndex(h => h.toLowerCase().includes('open date'));
  const pnlIdx = headers.findIndex(h => h.toLowerCase() === 'pnl');
  const winLossIdx = headers.findIndex(h => h.toLowerCase().includes('win/loss'));
  const tickerIdx = headers.findIndex(h => h.toLowerCase() === 'ticker');
  const directionIdx = headers.findIndex(h => h.toLowerCase() === 'direction');

  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    
    const dateStr = cols[dateIdx] || '';
    if (!dateStr) continue;
    
    const pnlStr = (cols[pnlIdx] || '').replace(/[^0-9,.-]/g, '').replace(',', '.');
    const pnl = parseFloat(pnlStr) || 0;
    
    const parts = dateStr.trim().split(/\s+/);
    if (parts.length < 3) continue;
    
    const day = parseInt(parts[0]);
    const monthMap = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
    const monthStr = parts[1].toLowerCase();
    const month = monthMap[monthStr];
    if (month === undefined) continue;
    
    const yearShort = parseInt(parts[2]);
    const year = yearShort < 100 ? 2000 + yearShort : yearShort;
    
    const date = new Date(year, month, day);
    const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    
    const winLoss = cols[winLossIdx] || '';
    const ticker = cols[tickerIdx] || '';
    const direction = cols[directionIdx] || '';

    const trade = { date, dateKey, pnl, winLoss, ticker, direction };
    allTrades.push(trade);
    allTradesUnfiltered.push(trade);

    if (!dailyData[dateKey]) {
      dailyData[dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[dateKey].pnl += pnl;
    dailyData[dateKey].tradeCount += 1;
    if (pnl > 0) dailyData[dateKey].wins += 1;
    else if (pnl < 0) dailyData[dateKey].losses += 1;
    else dailyData[dateKey].breakeven += 1;
  }
}

// ============================================================
// UTILITIES
// ============================================================
function formatCurrency(val) {
  const absVal = Math.abs(val);
  if (absVal >= 1000) {
    return '$' + (val/1000).toFixed(1) + 'K';
  }
  return '$' + val.toFixed(2);
}

// ============================================================
// RENDER ALL
// ============================================================
function renderAll() {
  renderMetrics();
  renderCumulativeChart();
  renderDailyChart();
  renderCalendar();
}

// ============================================================
// RENDER METRICS
// ============================================================
function renderMetrics() {
  const totalPnl = allTrades.reduce((sum, t) => sum + t.pnl, 0);
  document.getElementById('val-pnl').textContent = formatCurrency(totalPnl);
  document.getElementById('val-pnl').className = 'metric-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

  const wins = allTrades.filter(t => t.pnl > 0).length;
  const losses = allTrades.filter(t => t.pnl < 0).length;
  const breakeven = allTrades.filter(t => t.pnl === 0).length;
  const total = allTrades.length;
  const winRate = total > 0 ? (wins / total) * 100 : 0;

  document.getElementById('val-winrate').textContent = winRate.toFixed(2) + '%';
  document.getElementById('val-wins').textContent = wins;
  document.getElementById('val-losses').textContent = losses;
  document.getElementById('val-breakeven').textContent = breakeven;

  const gaugeArc = document.getElementById('gauge-arc');
  const gaugeArcLoss = document.getElementById('gauge-arc-loss');
  const arcLength = 94.25;
  const lossRate = total > 0 ? (losses / total) * 100 : 0;
  
  const winOffset = arcLength * (1 - winRate / 100);
  gaugeArc.style.strokeDashoffset = winOffset;
  
  const lossLength = arcLength * (lossRate / 100);
  gaugeArcLoss.style.strokeDasharray = `${lossLength} ${arcLength}`;
  gaugeArcLoss.style.strokeDashoffset = -arcLength * (winRate / 100);

  const grossProfit = allTrades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0);
  const grossLoss = Math.abs(allTrades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0));
  const pf = grossLoss > 0 ? grossProfit / grossLoss : 0;

  document.getElementById('val-pf').textContent = pf > 0 ? pf.toFixed(2) : '—';
  document.getElementById('val-pf').className = 'metric-value ' + (pf >= 1 ? 'positive' : 'negative');

  const pfGauge = document.getElementById('pf-gauge-circle');
  const pfCircumference = 163.36;
  const pfPercent = Math.min(pf / 3, 1);
  pfGauge.style.strokeDashoffset = pfCircumference * (1 - pfPercent);
  pfGauge.style.stroke = pf >= 1 ? '#00c9a7' : '#ff4757';

  const avgWin = wins > 0 ? grossProfit / wins : 0;
  const avgLoss = losses > 0 ? grossLoss / losses : 0;
  const ratio = avgLoss > 0 ? avgWin / avgLoss : 0;
  
  document.getElementById('val-ratio').textContent = ratio > 0 ? ratio.toFixed(2) : '—';
  document.getElementById('label-avgwin').textContent = formatCurrency(avgWin);
  document.getElementById('label-avgloss').textContent = '-' + formatCurrency(avgLoss);

  const winPart = document.getElementById('avg-bar-win');
  const lossPart = document.getElementById('avg-bar-loss');
  const totalAvg = avgWin + avgLoss;
  if (totalAvg > 0) {
    winPart.style.flex = (avgWin / totalAvg);
    lossPart.style.flex = (avgLoss / totalAvg);
  }
}

// ============================================================
// RENDER CUMULATIVE CHART
// ============================================================
function renderCumulativeChart() {
  const keys = Object.keys(dailyData).sort();
  if (keys.length === 0) return;

  const labels = [];
  const values = [];
  let cumulative = 0;

  const firstDate = new Date(keys[0]);
  const lastDate = new Date(keys[keys.length - 1]);
  
  for (let d = new Date(firstDate); d <= lastDate; d.setDate(d.getDate() + 1)) {
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const day = dailyData[key];
    if (day) {
      cumulative += day.pnl;
    }
    const label = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(2)}`;
    labels.push(label);
    values.push(cumulative);
  }

  const ctx = document.getElementById('cumulativeChart').getContext('2d');
  cumulativeChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 0,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          grid: { color: 'hsl(0,0%,10%)' },
          ticks: { color: '#8e8e8e', maxTicksLimit: 8, font: { family: 'Manrope', size: 10 }, maxRotation: 45 }
        },
        y: {
          grid: { color: 'hsl(0,0%,10%)' },
          ticks: { color: '#8e8e8e', font: { family: 'Manrope', size: 10 }, callback: v => formatCurrency(v) }
        }
      }
    }
  });
}

// ============================================================
// RENDER DAILY CHART
// ============================================================
function renderDailyChart() {
  const keys = Object.keys(dailyData).sort();
  if (keys.length === 0) return;

  const labels = [];
  const values = [];
  const colors = [];

  keys.forEach(key => {
    const day = dailyData[key];
    const date = new Date(key);
    const label = `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${String(date.getFullYear()).slice(2)}`;
    labels.push(label);
    values.push(day.pnl);
    colors.push(day.pnl >= 0 ? '#00c9a7' : '#ff4757');
  });

  const ctx = document.getElementById('dailyChart').getContext('2d');
  dailyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderRadius: 4,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: '#8e8e8e', maxTicksLimit: 8, font: { family: 'Manrope', size: 10 }, maxRotation: 45 }
        },
        y: {
          grid: { color: 'hsl(0,0%,10%)' },
          ticks: { color: '#8e8e8e', font: { family: 'Manrope', size: 10 }, callback: v => formatCurrency(v) }
        }
      }
    }
  });
}

// ============================================================
// RENDER CALENDAR
// ============================================================
function renderCalendar() {
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('calendarMonth').textContent = `${monthNames[calendarMonth]} ${calendarYear}`;

  const firstDay = new Date(calendarYear, calendarMonth, 1);
  const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
  const daysInMonth = lastDay.getDate();
  
  let startDay = firstDay.getDay();
  startDay = startDay === 0 ? 6 : startDay - 1;

  const grid = document.getElementById('calendarGrid');
  grid.innerHTML = '';

  for (let i = 0; i < startDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day';
    empty.style.background = 'transparent';
    empty.style.border = 'none';
    grid.appendChild(empty);
  }

  const today = new Date();
  const todayKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

  let monthPnl = 0;
  let tradingDays = 0;

  for (let day = 1; day <= daysInMonth; day++) {
    const dateKey = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const dayData = dailyData[dateKey];

    const cell = document.createElement('div');
    cell.className = 'calendar-day';
    
    if (dateKey === todayKey) {
      cell.classList.add('today');
    }

    if (dayData) {
      monthPnl += dayData.pnl;
      tradingDays++;
      cell.classList.add(dayData.pnl >= 0 ? 'positive' : 'negative');
      
      const pnlDiv = document.createElement('div');
      pnlDiv.className = 'calendar-day-pnl ' + (dayData.pnl >= 0 ? 'positive' : 'negative');
      pnlDiv.textContent = formatCurrency(dayData.pnl);
      
      const metaDiv = document.createElement('div');
      metaDiv.className = 'calendar-day-meta';
      metaDiv.textContent = `${dayData.tradeCount} trade${dayData.tradeCount !== 1 ? 's' : ''}`;
      const winPct = dayData.tradeCount > 0 ? (dayData.wins / dayData.tradeCount * 100) : 0;
      if (dayData.tradeCount > 0) {
        metaDiv.textContent += `\n${Math.round(winPct)}%`;
      }
      
      cell.innerHTML = `<div class="calendar-day-num">${day}</div>`;
      cell.appendChild(pnlDiv);
      cell.appendChild(metaDiv);
    } else {
      cell.innerHTML = `<div class="calendar-day-num">${day}</div>`;
    }

    grid.appendChild(cell);
  }

  document.getElementById('monthlyPnl').textContent = formatCurrency(monthPnl);
  document.getElementById('monthlyPnl').className = 'calendar-stats-pnl ' + (monthPnl >= 0 ? 'positive' : 'negative');
  document.getElementById('monthlyDays').textContent = `${tradingDays} day${tradingDays !== 1 ? 's' : ''}`;

  renderWeeklySidebar(calendarYear, calendarMonth, daysInMonth, startDay);
}

function renderWeeklySidebar(year, month, daysInMonth, startDay) {
  const sidebar = document.getElementById('weeklySidebar');
  sidebar.innerHTML = '';

  const weeks = [];
  let currentWeek = { start: 1, end: 0, pnl: 0, days: 0 };

  for (let day = 1; day <= daysInMonth; day++) {
    const dayOfWeek = (startDay + day - 1) % 7;
    
    if (currentWeek.end === 0) {
      currentWeek.start = day;
    }
    currentWeek.end = day;

    const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const dayData = dailyData[dateKey];
    if (dayData) {
      currentWeek.pnl += dayData.pnl;
      currentWeek.days++;
    }

    if (dayOfWeek === 6 || day === daysInMonth) {
      weeks.push({ ...currentWeek });
      currentWeek = { start: day + 1, end: 0, pnl: 0, days: 0 };
    }
  }

  weeks.forEach((week, idx) => {
    const weekDiv = document.createElement('div');
    weekDiv.className = 'week-item';
    
    const label = document.createElement('div');
    label.className = 'week-label';
    label.textContent = `Week ${idx + 1}`;
    
    const pnl = document.createElement('div');
    pnl.className = 'week-pnl ' + (week.pnl >= 0 ? 'positive' : 'negative');
    pnl.textContent = formatCurrency(week.pnl);
    
    const days = document.createElement('div');
    days.className = 'week-days';
    days.textContent = `${week.days} day${week.days !== 1 ? 's' : ''}`;
    
    weekDiv.appendChild(label);
    weekDiv.appendChild(pnl);
    weekDiv.appendChild(days);
    sidebar.appendChild(weekDiv);
  });
}

function changeMonth(delta) {
  calendarMonth += delta;
  if (calendarMonth < 0) {
    calendarMonth = 11;
    calendarYear--;
  } else if (calendarMonth > 11) {
    calendarMonth = 0;
    calendarYear++;
  }
  renderCalendar();
}

function goToCurrentMonth() {
  const now = new Date();
  calendarMonth = now.getMonth();
  calendarYear = now.getFullYear();
  renderCalendar();
}

// ============================================================
// INIT
// ============================================================
loadData();
</script>
</body>
</html>
