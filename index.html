<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  /* ============================================================
     CSS VARIABLES - CodePen-inspired Design System
     ============================================================ */
  :root {
    /* Colors - HSL based like CodePen */
    --color-bg-dark: hsl(0, 0%, 0%);
    --color-bg: hsl(0, 0%, 5%);
    --color-bg-light: hsl(0, 0%, 10%);
    --color-border: hsl(0, 0%, 10%);
    --color-border-light: hsl(0, 0%, 20%);
    --color-text: hsl(0, 0%, 95%);
    --color-text-light: hsl(0, 0%, 75%);
    --color-text-muted: hsl(0, 0%, 55%);
    --color-green: #00c9a7;
    --color-red: #ff4757;
    --color-accent: #00c9a7;
    
    /* Gradients */
    --gradient-card: linear-gradient(0deg, var(--color-bg) 95%, var(--color-bg-light));
    --gradient-card-hover: linear-gradient(0deg, var(--color-bg), var(--color-bg-light));
    
    /* Typography */
    --ff: "Manrope", sans-serif;
    
    /* Spacing - Consistent */
    --rounded: 0.75rem;
    --card-padding: 1.5rem;
    --spacing-xs: 0.5rem;
    --spacing-sm: 1rem;
    --spacing-md: 1.5rem;
    --spacing-lg: 2rem;
    
    /* Shadows */
    --shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
    
    /* Legacy aliases for compatibility */
    --bg-deep: var(--color-bg-dark);
    --bg-card: var(--color-bg);
    --border: var(--color-border);
    --green: var(--color-green);
    --red: var(--color-red);
    --text-primary: var(--color-text);
    --text-secondary: var(--color-text-light);
    --text-muted: var(--color-text-muted);
    --accent: var(--color-accent);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: var(--ff);
    background: var(--color-bg-dark);
    color: var(--color-text);
    min-height: 100vh;
    margin: 0 auto;
    width: 95%;
  }
  
  @media (max-width: 600px) {
    body {
      width: 95%;
    }
  }

  /* Header */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-bg-dark);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }
  
  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-sm);
    }
  }
  
  .header h1 {
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .header .subtitle {
    color: var(--text-secondary);
    font-size: 13px;
    margin-top: 2px;
  }
  
  /* Apply button */
  .apply-btn:hover {
    background: var(--gradient-card-hover) !important;
  }
  
  /* Calendar button */
  .calendar-btn:hover {
    background: var(--gradient-card-hover);
  }
  .calendar-btn svg {
    stroke: var(--color-text);
  }
  
  /* Account dropdown */
  .account-dropdown-wrapper {
    position: relative;
  }
  
  .account-btn {
    font-family: Manrope;
    font-size: 12px;
  }
  
  .account-btn:hover {
    background: var(--gradient-card-hover);
  }
  
  .account-btn svg {
    stroke: var(--color-text);
  }
  
  .account-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    min-width: 200px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    padding: 8px 0;
    z-index: 1000;
  }
  
  .account-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .account-option:hover {
    background: var(--color-bg-light);
  }
  
  .account-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--green);
  }
  
  .account-option label {
    cursor: pointer;
    font-size: 13px;
    color: var(--color-text);
    flex: 1;
  }
  
  .account-section-title {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 16px 8px 16px;
    font-weight: 600;
  }
  
  /* Date Picker Modal */
  .date-picker-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .date-picker-content {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--rounded);
    width: 90%;
    max-width: 900px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  }
  .date-picker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }
  .date-display {
    display: flex;
    align-items: center;
    font-size: 1rem;
    font-weight: 500;
  }
  .close-btn {
    background: none;
    border: none;
    color: var(--color-text);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }
  .close-btn:hover {
    background: var(--color-bg-light);
  }
  .date-picker-body {
    padding: 1.5rem;
    display: flex;
    gap: 1.5rem;
  }
  
  .calendars-container {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }
  
  .calendar-picker {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .calendar-picker-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }
  
  .month-year {
    display: flex;
    gap: 0.5rem;
  }
  
  .month-year select {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    padding: 6px 10px;
    border-radius: 6px;
    font-family: Manrope;
    font-size: 13px;
    cursor: pointer;
  }
  
  .month-nav {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .month-nav:hover {
    background: var(--color-bg);
  }
  
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
  }
  
  .cal-weekday {
    text-align: center;
    font-size: 11px;
    color: var(--text-muted);
    padding: 8px 0;
    font-weight: 600;
  }
  
  .cal-day-picker {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .cal-day-picker:hover:not(.empty):not(.disabled) {
    background: var(--color-bg-light);
  }
  
  .cal-day-picker.selected {
    background: var(--green);
    color: var(--color-bg-dark);
    font-weight: 600;
  }
  
  .cal-day-picker.in-range {
    background: rgba(0, 201, 167, 0.15);
  }
  
  .cal-day-picker.today {
    border: 1px solid var(--color-border-light);
  }
  
  .cal-day-picker.empty {
    cursor: default;
  }
  
  .cal-day-picker.disabled {
    color: var(--text-muted);
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .presets-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 160px;
  }
  
  .preset-btn {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    padding: 10px 16px;
    border-radius: 6px;
    font-family: Manrope;
    font-size: 13px;
    cursor: pointer;
    text-align: left;
    transition: background 0.2s ease;
  }
  
  .preset-btn:hover {
    background: var(--color-bg);
  }
  
  @media (max-width: 800px) {
    .date-picker-content {
      max-width: 95%;
    }
    .calendars-container {
      grid-template-columns: 1fr;
    }
    .date-picker-body {
      flex-direction: column;
    }
  }
  
  .date-picker-footer {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--color-border);
    justify-content: flex-end;
  }
  
  .btn-secondary {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    padding: 8px 16px;
    border-radius: 6px;
    font-family: Manrope;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .btn-secondary:hover {
    background: var(--color-bg);
  }
  
  .btn-primary {
    background: var(--gradient-card);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    color: var(--color-text);
    padding: 8px 16px;
    border-radius: 6px;
    font-family: Manrope;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .btn-primary:hover {
    background: var(--gradient-card-hover);
  }
  
  /* Hamburger button */
  .hamburger {
    background: none;
    border: none;
    color: var(--color-text);
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background 0.2s ease;
  }
  .hamburger:hover {
    background: var(--color-bg-light);
  }
  .hamburger svg {
    width: 20px;
    height: 20px;
    stroke: var(--color-text);
  }
  
  /* Container for sidebar + main content */
  .container {
    display: flex;
    gap: 2rem;
    position: relative;
    margin-top: 1rem;
  }
  
  .main-content {
    flex: 1;
    min-width: 0;
  }
  
  /* Sidebar */
  .sidebar {
    position: sticky;
    top: 80px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-self: flex-start;
    width: 200px;
    flex-shrink: 0;
    z-index: 10;
  }
  .show-sidebar {
    display: flex !important;
  }
  .hide-sidebar {
    display: none !important;
  }
  .sidebar-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: var(--color-text-light);
    text-decoration: none;
    border-radius: var(--rounded);
    transition: background 0.2s ease;
    font-size: 14px;
    cursor: default;
  }
  .sidebar-link:hover {
    background: var(--color-bg-light);
  }
  .sidebar-link.active-link {
    color: var(--color-text);
    font-weight: 600;
  }
  .sidebar-link.active-link svg {
    stroke-width: 2.5;
  }
  .sidebar-link svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    flex-shrink: 0;
  }
  
  @media (max-width: 800px) {
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      background: var(--color-bg-dark);
      padding: 80px 20px 20px 20px;
      z-index: 99;
      box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    }
  }

  /* Config input for CSV URL */
  .config-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 24px;
  }
  .config-bar input {
    flex:1;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 8px 14px;
    border-radius: 8px;
    font-family: var(--ff);
    font-size: 12px;
    outline: none;
  }
  .config-bar input:focus { border-color: var(--accent); }
  .config-bar button {
    background: var(--accent);
    color: #0a0c0f;
    border: none;
    padding: 8px 18px;
    border-radius: 8px;
    font-family: var(--ff);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
  }
  .config-bar button:hover { opacity: 0.85; }

  /* Metric Cards */
  .metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  @media (min-width: 1200px) {
    .metrics-row {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  
  .metric-card {
    background: var(--gradient-card);
    border: 1px solid var(--color-border);\n    border-top: 1px solid var(--color-border-light);
    box-shadow: var(--shadow);
    border-radius: var(--rounded);
    padding: var(--card-padding);
    position: relative;
    overflow: hidden;
    transition: background 0.2s ease;
  }
  .metric-card:hover {
    background: var(--gradient-card-hover);
  }
  .metric-card .label {
    font-size: 0.75rem;
    color: var(--color-text-light);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-xs);
  }
  .metric-card .value {
    font-size: 26px;
    font-weight: 700;
    letter-spacing: -1px;
  }
  .metric-card .value.positive { color: var(--green); }
  .metric-card .value.negative { color: var(--red); }

  /* Gauge styles */
  .gauge-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 4px;
  }
  .gauge-svg { width: 64px; height: 64px; }
  .gauge-stats { display: flex; gap: 12px; }
  .gauge-stat { font-size: 11px; }
  .gauge-stat .gs-val { font-weight: 600; font-size: 13px; }
  .gauge-stat.win .gs-val { color: var(--green); }
  .gauge-stat.loss .gs-val { color: var(--red); }
  .gauge-stat.neutral .gs-val { color: var(--text-secondary); }

  /* Avg win/loss bar */
  .avg-bar {
    display: flex;
    margin-top: 10px;
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    gap: 3px;
  }
  .avg-bar .win-part { background: var(--green); flex: 1; border-radius: 3px; }
  .avg-bar .loss-part { background: var(--red); flex: 1; border-radius: 3px; }
  .avg-bar-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
  }
  .avg-bar-labels span { font-size: 11px; font-weight: 500; }
  .avg-bar-labels .win-label { color: var(--green); }
  .avg-bar-labels .loss-label { color: var(--red); }

  /* Charts Row */
  .charts-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(400px, 100%), 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .chart-card {
    background: var(--gradient-card);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    box-shadow: var(--shadow);
    border-radius: var(--rounded);
    padding: var(--card-padding);
    transition: background 0.2s ease;
    min-height: 280px;
  }
  .chart-card:hover {
    background: var(--gradient-card-hover);
  }
  .chart-card .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
  }
  .chart-card .chart-title {
    font-size: 12px;
    font-weight: 500;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .chart-card canvas { 
    width: 100% !important; 
    height: max(200px, 20vh) !important;
  }
  
  @media (min-width: 768px) {
    .chart-card canvas {
      height: 220px !important;
    }
  }

  /* Calendar */
  .calendar-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 24px;
    margin-bottom: 24px;
    overflow-x: auto;
  }
  
  @media (max-width: 768px) {
    .calendar-section {
      padding: 16px;
    }
  }
  .calendar-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .calendar-nav .nav-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .calendar-nav .month-title {
    font-size: 16px;
    font-weight: 600;
  }
  .nav-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-primary);
    width: 30px; height: 30px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
  }
  .nav-btn:hover { background: var(--bg-card-hover); }
  .this-month-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    font-family: var(--ff);
  }
  .this-month-btn:hover { background: var(--bg-card-hover); }
  .monthly-stats {
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .monthly-stats .ms-pnl { font-weight: 600; font-size: 16px; }
  .monthly-stats .ms-pnl.positive { color: var(--green); }
  .monthly-stats .ms-pnl.negative { color: var(--red); }
  .monthly-stats .ms-days { color: var(--text-muted); font-size: 12px; }

  .calendar-grid-wrapper {
    display: flex;
    gap: 16px;
  }
  
  @media (max-width: 768px) {
    .calendar-grid-wrapper {
      flex-direction: column;
    }
    .weekly-sidebar {
      flex-direction: row;
      width: 100%;
      overflow-x: auto;
    }
  }
  
  .calendar-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    min-width: 0;
  }
  .cal-header {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    padding: 8px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .cal-day {
    background: var(--color-bg-light);
    border-radius: var(--rounded);
    padding: var(--spacing-xs);
    min-height: 100px;
    position: relative;
    border: 1px solid transparent;
  }
  .cal-day.positive { background: rgba(0,201,167,0.08); border-color: rgba(0,201,167,0.2); }
  .cal-day.negative { background: rgba(255,71,87,0.08); border-color: rgba(255,71,87,0.2); }
  .cal-day .day-num {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
    text-align: right;
  }
  .cal-day.today .day-num { 
    width: 24px;
    height: 24px;
    line-height: 24px;
    color: var(--color-bg-dark);
    font-weight: 600;
    background: #ffffff;
    border-radius: 50%;
    text-align: center;
    display: block;
    margin-left: auto;
    margin-bottom: 4px;
  }
  .cal-day .day-pnl {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }
  .cal-day .day-pnl.positive { color: var(--green); }
  .cal-day .day-pnl.negative { color: var(--red); }
  .cal-day .day-meta {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 2px;
    line-height: 1.4;
  }

  /* Weekly sidebar */
  .weekly-sidebar {
    width: 120px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .week-item {
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--rounded);
    padding: var(--spacing-xs);
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
    margin-bottom: 4px;
  }
  .week-item:last-child {
    margin-bottom: 0;
  }
  .week-item .week-label {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    margin-bottom: 3px;
  }
  .week-item .week-pnl {
    font-size: 14px;
    font-weight: 600;
  }
  .week-item .week-pnl.positive { color: var(--green); }
  .week-item .week-pnl.negative { color: var(--red); }
  .week-item .week-pnl.neutral { color: var(--text-muted); }
  .week-item .week-days {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* Loading */
  .loading {
    color: var(--text-secondary);
    font-size: 13px;
    padding: 40px;
    text-align: center;
  }

  /* Empty state for calendar days */
  .cal-day.empty { opacity: 0.3; }
</style>
</head>
<body>

<div class="header">
  <div style="display:flex; align-items:center; gap:16px;">
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="4" x2="20" y1="12" y2="12" />
        <line x1="4" x2="20" y1="6" y2="6" />
        <line x1="4" x2="20" y1="18" y2="18" />
      </svg>
    </button>
    <h1>Trading Dashboard</h1>
  </div>
  <div style="display:flex; gap:12px; align-items:center;">
    <button onclick="toggleDatePicker()" class="calendar-btn" style="background:var(--gradient-card);border:1px solid var(--color-border);border-top:1px solid var(--color-border-light);color:var(--color-text);padding:8px 12px;border-radius:8px;cursor:pointer;transition:background 0.2s ease;display:flex;align-items:center;gap:8px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <span id="dateRangeText">All time</span>
    </button>
    <div class="account-dropdown-wrapper">
      <button onclick="toggleAccountDropdown()" class="account-btn" id="accountBtn" style="background:var(--gradient-card);border:1px solid var(--color-border);border-top:1px solid var(--color-border-light);color:var(--color-text);padding:8px 12px;border-radius:8px;cursor:pointer;transition:background 0.2s ease;display:flex;align-items:center;gap:8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span id="selectedAccountText">My Account</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
      <div class="account-dropdown" id="accountDropdown" style="display:none;">
        <div class="account-option" data-value="all">
          <input type="checkbox" id="account-all" />
          <label for="account-all">All accounts</label>
        </div>
        <div class="account-section-title">My accounts</div>
        <div id="accountOptionsList"></div>
      </div>
    </div>
  </div>
</div>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <span id="dateRangeText">All time</span>
    </button>
  </div>
</div>

<!-- Date Picker Modal -->
<div id="datePickerModal" class="date-picker-modal" style="display:none;">
  <div class="date-picker-content">
    <div class="date-picker-header">
      <div class="date-display">
        <span id="displayFromDate">January 01, 2026</span>
        <span style="margin: 0 12px; color: var(--text-muted);">→</span>
        <span id="displayToDate">February 28, 2026</span>
      </div>
      <button onclick="toggleDatePicker()" class="close-btn">×</button>
    </div>
    
    <div class="date-picker-body">
      <div class="calendars-container">
        <div class="calendar-picker">
          <div class="calendar-picker-header">
            <button onclick="prevMonth('from')" class="month-nav">‹</button>
            <div class="month-year">
              <select id="fromMonth" onchange="updateFromCalendar()"></select>
              <select id="fromYear" onchange="updateFromCalendar()"></select>
            </div>
            <button onclick="nextMonth('from')" class="month-nav">›</button>
          </div>
          <div class="calendar-grid">
            <div class="cal-weekday">Su</div>
            <div class="cal-weekday">Mo</div>
            <div class="cal-weekday">Tu</div>
            <div class="cal-weekday">We</div>
            <div class="cal-weekday">Th</div>
            <div class="cal-weekday">Fr</div>
            <div class="cal-weekday">Sa</div>
            <div id="fromCalendarDays"></div>
          </div>
        </div>
        
        <div class="calendar-picker">
          <div class="calendar-picker-header">
            <button onclick="prevMonth('to')" class="month-nav">‹</button>
            <div class="month-year">
              <select id="toMonth" onchange="updateToCalendar()"></select>
              <select id="toYear" onchange="updateToCalendar()"></select>
            </div>
            <button onclick="nextMonth('to')" class="month-nav">›</button>
          </div>
          <div class="calendar-grid">
            <div class="cal-weekday">Su</div>
            <div class="cal-weekday">Mo</div>
            <div class="cal-weekday">Tu</div>
            <div class="cal-weekday">We</div>
            <div class="cal-weekday">Th</div>
            <div class="cal-weekday">Fr</div>
            <div class="cal-weekday">Sa</div>
            <div id="toCalendarDays"></div>
          </div>
        </div>
      </div>
      
      <div class="presets-container">
        <button onclick="applyPreset('today')" class="preset-btn">Today</button>
        <button onclick="applyPreset('week')" class="preset-btn">This week</button>
        <button onclick="applyPreset('month')" class="preset-btn">This month</button>
        <button onclick="applyPreset('30days')" class="preset-btn">Last 30 days</button>
        <button onclick="applyPreset('lastmonth')" class="preset-btn">Last month</button>
        <button onclick="applyPreset('quarter')" class="preset-btn">This quarter</button>
        <button onclick="applyPreset('ytd')" class="preset-btn">YTD (year to date)</button>
      </div>
    </div>
    
    <div class="date-picker-footer">
      <button onclick="clearDateFilter()" class="btn-secondary">Clear</button>
      <button onclick="applyDateFilterFromPicker()" class="btn-primary">Apply</button>
    </div>
  </div>
</div>

<div class="container">
<aside class="sidebar show-sidebar">
  <a href="index.html" class="sidebar-link active-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8" />
      <path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
    </svg>
    Home
  </a>
  <a href="trades.html" class="sidebar-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 3v16a2 2 0 0 0 2 2h16" />
      <path d="M7 16c.5-2 1.5-7 4-7 2 0 2 3 4 3 2.5 0 4.5-5 5-7" />
    </svg>
    Trades
  </a>
  <a href="javascript:void(0)" class="sidebar-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
      <circle cx="12" cy="12" r="3" />
    </svg>
    Settings
  </a>
</aside>

<div class="main-content">

<div class="config-bar">
  <span style="color:var(--text-muted);font-size:12px;">Loading trade data...</span>
  <span id="loadStatus" style="color:var(--green);font-size:12px;display:none;">✓ Data loaded</span>
</div>

<!-- Metric Cards -->
<div class="metrics-row" style="grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));">
  <div class="metric-card" id="card-balance">
    <div class="label">Account Balance</div>
    <div class="value" id="val-current-balance" style="margin-top:4px;">—</div>
  </div>
  <div class="metric-card" id="card-pnl">
    <div class="label">Net P&L </div>
    <div class="value" id="val-pnl">—</div>
  </div>
  <div class="metric-card" id="card-winrate" style="position:relative;">
    <div style="position:absolute; top:50%; right:var(--card-padding); transform:translateY(-50%); display:flex; flex-direction:column; align-items:center;">
      <svg class="gauge-svg" viewBox="0 0 80 40" style="width:90px; height:45px;">
        <path d="M 10 35 A 30 30 0 0 1 70 35" fill="none" stroke="hsl(0,0%,10%)" stroke-width="6" stroke-linecap="round"/>
        <path d="M 10 35 A 30 30 0 0 1 70 35" fill="none" stroke="#ff4757" stroke-width="6" stroke-linecap="round" id="gauge-arc-loss" stroke-dasharray="94.25" stroke-dashoffset="0"/>
        <path d="M 10 35 A 30 30 0 0 1 70 35" fill="none" stroke="#00c9a7" stroke-width="6" stroke-linecap="round" id="gauge-arc" stroke-dasharray="94.25" stroke-dashoffset="94.25"/>
      </svg>
      <div class="gauge-stats" style="margin-top:8px;">
        <div class="gauge-stat win"><div class="gs-val" id="val-wins">0</div></div>
        <div class="gauge-stat neutral"><div class="gs-val" id="val-breakeven">0</div></div>
        <div class="gauge-stat loss"><div class="gs-val" id="val-losses">0</div></div>
      </div>
    </div>
    <div class="label">Trade win %</div>
    <div class="value" id="val-winrate" style="margin-top:4px;">—</div>
  </div>
  <div class="metric-card" id="card-pf" style="position:relative;">
    <div style="position:absolute; top:50%; right:var(--card-padding); transform:translateY(-50%); display:flex; justify-content:center;">
      <svg class="gauge-svg" viewBox="0 0 64 64" style="width:70px; height:70px;">
        <circle cx="32" cy="32" r="28" fill="none" stroke="hsl(0,0%,10%)" stroke-width="6" stroke-linecap="round" stroke-dasharray="176" stroke-dashoffset="0" transform="rotate(-90 32 32)"/>
        <circle cx="32" cy="32" r="28" fill="none" stroke="hsl(0,0%,20%)" stroke-width="6" stroke-linecap="round" stroke-dasharray="176" stroke-dashoffset="176" id="pf-gauge-circle" transform="rotate(-90 32 32)"/>
      </svg>
    </div>
    <div class="label">Profit factor</div>
    <div class="value" id="val-pf" style="margin-top:4px;">—</div>
  </div>
  <div class="metric-card" id="card-avg">
    <div class="label">Avg win / loss trade</div>
    <div style="display:flex; align-items:center; gap:16px; margin-top:4px;">
      <div class="value" id="val-ratio" style="font-size:26px; white-space:nowrap;">—</div>
      <div style="flex:1; min-width:100px;">
        <div class="avg-bar" id="avg-bar"><div class="win-part"></div><div class="loss-part"></div></div>
        <div class="avg-bar-labels">
          <span class="win-label" id="label-avgwin">—</span>
          <span class="loss-label" id="label-avgloss">—</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="charts-row">
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">Daily net cumulative P&L </div>
    </div>
    <canvas id="cumulativeChart" height="220"></canvas>
  </div>
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">Net daily P&L </div>
    </div>
    <canvas id="dailyChart" height="220"></canvas>
  </div>
</div>

<!-- Calendar -->
<div class="calendar-section">
  <div class="calendar-nav">
    <div class="nav-left">
      <button class="nav-btn" onclick="changeMonth(-1)">&#8592;</button>
      <span class="month-title" id="cal-month-title">January 2026</span>
      <button class="nav-btn" onclick="changeMonth(1)">&#8594;</button>
      <button class="this-month-btn" onclick="goToThisMonth()">This month</button>
    </div>
    <div class="monthly-stats">
      <span class="ms-pnl positive" id="cal-monthly-pnl">$0</span>
      <span class="ms-days" id="cal-trading-days">0 days</span>
    </div>
  </div>
  <div class="calendar-grid-wrapper">
    <div class="calendar-grid" id="calendarGrid"></div>
    <div class="weekly-sidebar" id="weeklySidebar"></div>
  </div>
</div>

<script>
// ============================================================
// SIDEBAR TOGGLE
// ============================================================
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  sidebar.classList.toggle('show-sidebar');
  sidebar.classList.toggle('hide-sidebar');
}

// Initialize sidebar visibility based on screen size
window.addEventListener('DOMContentLoaded', () => {
  const sidebar = document.querySelector('.sidebar');
  if (window.innerWidth <= 800) {
    sidebar.classList.remove('show-sidebar');
    sidebar.classList.add('hide-sidebar');
  } else {
    sidebar.classList.add('show-sidebar');
    sidebar.classList.remove('hide-sidebar');
  }
});

// Handle sidebar on window resize
window.addEventListener('resize', () => {
  const sidebar = document.querySelector('.sidebar');
  if (window.innerWidth > 800 && sidebar.classList.contains('hide-sidebar')) {
    sidebar.classList.remove('hide-sidebar');
    sidebar.classList.add('show-sidebar');
  }
});

// ============================================================
// DATA STORE
// ============================================================
let allTrades = [];
let allTradesUnfiltered = []; // Store original unfiltered data
let dailyData = {}; // { "2026-01-21": { pnl, tradeCount, wins, losses } }
let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();
let cumulativeChart = null;
let dailyChart = null;
let dateFilterFrom = null;
let dateFilterTo = null;

// Account balance tracking
let accountBalances = {}; // { "Account Name": { deposits: 0, withdrawals: 0, startingBalance: 0 } }
let selectedAccount = 'all';
let availableAccounts = [];

// ============================================================
// DATE FILTER
// ============================================================
// Date Picker State
let pickerFromDate = null;
let pickerToDate = null;
let fromMonth = new Date().getMonth();
let fromYear = new Date().getFullYear();
let toMonth = new Date().getMonth() + 1;
let toYear = new Date().getFullYear();

if (toMonth > 11) {
  toMonth = 0;
  toYear++;
}

function toggleDatePicker() {
  const modal = document.getElementById('datePickerModal');
  const isOpening = modal.style.display === 'none';
  modal.style.display = isOpening ? 'flex' : 'none';
  
  if (isOpening) {
    initializeDatePicker();
  }
}

function initializeDatePicker() {
  // Initialize with current filter or default
  pickerFromDate = dateFilterFrom || new Date(new Date().getFullYear(), 0, 1);
  pickerToDate = dateFilterTo || new Date();
  
  fromMonth = pickerFromDate.getMonth();
  fromYear = pickerFromDate.getFullYear();
  toMonth = pickerToDate.getMonth();
  toYear = pickerToDate.getFullYear();
  
  populateMonthYearSelects();
  updateBothCalendars();
  updateDateDisplay();
}

function populateMonthYearSelects() {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const currentYear = new Date().getFullYear();
  
  // From month
  const fromMonthSelect = document.getElementById('fromMonth');
  fromMonthSelect.innerHTML = months.map((m, i) => 
    `<option value="${i}" ${i === fromMonth ? 'selected' : ''}>${m}</option>`
  ).join('');
  
  // From year
  const fromYearSelect = document.getElementById('fromYear');
  const years = [];
  for (let y = currentYear - 5; y <= currentYear + 1; y++) {
    years.push(y);
  }
  fromYearSelect.innerHTML = years.map(y => 
    `<option value="${y}" ${y === fromYear ? 'selected' : ''}>${y}</option>`
  ).join('');
  
  // To month
  const toMonthSelect = document.getElementById('toMonth');
  toMonthSelect.innerHTML = months.map((m, i) => 
    `<option value="${i}" ${i === toMonth ? 'selected' : ''}>${m}</option>`
  ).join('');
  
  // To year
  const toYearSelect = document.getElementById('toYear');
  toYearSelect.innerHTML = years.map(y => 
    `<option value="${y}" ${y === toYear ? 'selected' : ''}>${y}</option>`
  ).join('');
}

function updateFromCalendar() {
  fromMonth = parseInt(document.getElementById('fromMonth').value);
  fromYear = parseInt(document.getElementById('fromYear').value);
  renderCalendar('from', fromMonth, fromYear);
}

function updateToCalendar() {
  toMonth = parseInt(document.getElementById('toMonth').value);
  toYear = parseInt(document.getElementById('toYear').value);
  renderCalendar('to', toMonth, toYear);
}

function updateBothCalendars() {
  renderCalendar('from', fromMonth, fromYear);
  renderCalendar('to', toMonth, toYear);
}

function prevMonth(type) {
  if (type === 'from') {
    fromMonth--;
    if (fromMonth < 0) {
      fromMonth = 11;
      fromYear--;
    }
  } else {
    toMonth--;
    if (toMonth < 0) {
      toMonth = 11;
      toYear--;
    }
  }
  populateMonthYearSelects();
  updateBothCalendars();
}

function nextMonth(type) {
  if (type === 'from') {
    fromMonth++;
    if (fromMonth > 11) {
      fromMonth = 0;
      fromYear++;
    }
  } else {
    toMonth++;
    if (toMonth > 11) {
      toMonth = 0;
      toYear++;
    }
  }
  populateMonthYearSelects();
  updateBothCalendars();
}

function renderCalendar(type, month, year) {
  const container = document.getElementById(type === 'from' ? 'fromCalendarDays' : 'toCalendarDays');
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let html = '';
  
  // Empty cells before first day
  for (let i = 0; i < firstDay; i++) {
    html += '<div class="cal-day-picker empty"></div>';
  }
  
  // Days of month
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    date.setHours(0, 0, 0, 0);
    
    let classes = ['cal-day-picker'];
    
    // Check if today
    if (date.getTime() === today.getTime()) {
      classes.push('today');
    }
    
    // Check if selected
    if (pickerFromDate && date.getTime() === pickerFromDate.getTime()) {
      classes.push('selected');
    }
    if (pickerToDate && date.getTime() === pickerToDate.getTime()) {
      classes.push('selected');
    }
    
    // Check if in range
    if (pickerFromDate && pickerToDate && date > pickerFromDate && date < pickerToDate) {
      classes.push('in-range');
    }
    
    html += `<div class="${classes.join(' ')}" onclick="selectDate('${type}', ${year}, ${month}, ${day})">${day}</div>`;
  }
  
  container.innerHTML = html;
}

function selectDate(type, year, month, day) {
  const selected = new Date(year, month, day);
  selected.setHours(0, 0, 0, 0);
  
  if (type === 'from') {
    pickerFromDate = selected;
    // If from is after to, adjust to
    if (pickerToDate && pickerFromDate > pickerToDate) {
      pickerToDate = new Date(pickerFromDate);
    }
  } else {
    pickerToDate = selected;
    // If to is before from, adjust from
    if (pickerFromDate && pickerToDate < pickerFromDate) {
      pickerFromDate = new Date(pickerToDate);
    }
  }
  
  updateBothCalendars();
  updateDateDisplay();
}

function updateDateDisplay() {
  const options = { year: 'numeric', month: 'long', day: '2-digit' };
  document.getElementById('displayFromDate').textContent = pickerFromDate ? pickerFromDate.toLocaleDateString('en-US', options) : 'Select start date';
  document.getElementById('displayToDate').textContent = pickerToDate ? pickerToDate.toLocaleDateString('en-US', options) : 'Select end date';
}

function applyPreset(preset) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  switch(preset) {
    case 'today':
      pickerFromDate = new Date(today);
      pickerToDate = new Date(today);
      break;
    case 'week':
      const dayOfWeek = today.getDay();
      pickerFromDate = new Date(today);
      pickerFromDate.setDate(today.getDate() - dayOfWeek);
      pickerToDate = new Date(today);
      break;
    case 'month':
      pickerFromDate = new Date(today.getFullYear(), today.getMonth(), 1);
      pickerToDate = new Date(today);
      break;
    case '30days':
      pickerFromDate = new Date(today);
      pickerFromDate.setDate(today.getDate() - 30);
      pickerToDate = new Date(today);
      break;
    case 'lastmonth':
      pickerFromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      pickerToDate = new Date(today.getFullYear(), today.getMonth(), 0);
      break;
    case 'quarter':
      const quarter = Math.floor(today.getMonth() / 3);
      pickerFromDate = new Date(today.getFullYear(), quarter * 3, 1);
      pickerToDate = new Date(today);
      break;
    case 'ytd':
      pickerFromDate = new Date(today.getFullYear(), 0, 1);
      pickerToDate = new Date(today);
      break;
  }
  
  fromMonth = pickerFromDate.getMonth();
  fromYear = pickerFromDate.getFullYear();
  toMonth = pickerToDate.getMonth();
  toYear = pickerToDate.getFullYear();
  
  populateMonthYearSelects();
  updateBothCalendars();
  updateDateDisplay();
}

function applyDateFilterFromPicker() {
  dateFilterFrom = pickerFromDate;
  dateFilterTo = pickerToDate;
  
  // Filter allTrades
  if (dateFilterFrom || dateFilterTo) {
    allTrades = allTradesUnfiltered.filter(t => {
      if (dateFilterFrom && t.date < dateFilterFrom) return false;
      if (dateFilterTo && t.date > dateFilterTo) return false;
      return true;
    });
  } else {
    allTrades = [...allTradesUnfiltered];
  }
  
  // Rebuild dailyData from filtered trades
  dailyData = {};
  allTrades.forEach(t => {
    if (!dailyData[t.dateKey]) {
      dailyData[t.dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[t.dateKey].pnl += t.pnl;
    dailyData[t.dateKey].tradeCount += 1;
    if (t.pnl > 0) dailyData[t.dateKey].wins += 1;
    else if (t.pnl < 0) dailyData[t.dateKey].losses += 1;
    else dailyData[t.dateKey].breakeven += 1;
  });
  
  // Update button text
  let rangeText = 'All time';
  if (dateFilterFrom && dateFilterTo) {
    rangeText = `${dateFilterFrom.toLocaleDateString('en-GB', {day: '2-digit', month: 'short'})} - ${dateFilterTo.toLocaleDateString('en-GB', {day: '2-digit', month: 'short'})}`;
  } else if (dateFilterFrom) {
    rangeText = `From ${dateFilterFrom.toLocaleDateString('en-GB', {day: '2-digit', month: 'short'})}`;
  } else if (dateFilterTo) {
    rangeText = `Until ${dateFilterTo.toLocaleDateString('en-GB', {day: '2-digit', month: 'short'})}`;
  }
  document.getElementById('dateRangeText').textContent = rangeText;
  
  toggleDatePicker();
  renderAll();
}

function clearDateFilter() {
  pickerFromDate = null;
  pickerToDate = null;
  dateFilterFrom = null;
  dateFilterTo = null;
  allTrades = [...allTradesUnfiltered];
  
  // Rebuild dailyData from all trades
  dailyData = {};
  allTrades.forEach(t => {
    if (!dailyData[t.dateKey]) {
      dailyData[t.dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[t.dateKey].pnl += t.pnl;
    dailyData[t.dateKey].tradeCount += 1;
    if (t.pnl > 0) dailyData[t.dateKey].wins += 1;
    else if (t.pnl < 0) dailyData[t.dateKey].losses += 1;
    else dailyData[t.dateKey].breakeven += 1;
  });
  
  document.getElementById('dateRangeText').textContent = 'All time';
  toggleDatePicker();
  renderAll();
}



// ============================================================
// LOAD & PARSE CSV
// ============================================================
const GVIZ_URL = 'https://docs.google.com/spreadsheets/d/1lr6NH8wkv0lZvuriRLG2nCSlg-VGH6D6JA5sxDE7Bus/gviz/tq?tqx=out:csv&gid=653744386';
const PUB_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH3jFflZ0yd3k_owNsVgezKK00Z8HGehudo_5gqajVxvCqMCeCCwSwkDhx9484DVHY3z9hWMds2ime/pub?gid=653744386&single=true&output=csv';

// Balance sheet URLs
const BALANCE_GVIZ_URL = 'https://docs.google.com/spreadsheets/d/1lr6NH8wkv0lZvuriRLG2nCSlg-VGH6D6JA5sxDE7Bus/gviz/tq?tqx=out:csv&gid=832249258';
const BALANCE_PUB_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH3jFflZ0yd3k_owNsVgezKK00Z8HGehudo_5gqajVxvCqMCeCCwSwkDhx9484DVHY3z9hWMds2ime/pub?gid=832249258&single=true&output=csv';

async function loadData() {
  const statusEl = document.querySelector('.config-bar span:first-child');
  const successEl = document.getElementById('loadStatus');

  console.log('Starting data load...');
  console.log('Status elements:', statusEl, successEl);

  // Load trades data
  const urls = [PUB_URL, GVIZ_URL];

  for (const url of urls) {
    console.log('Trying URL:', url);
    try {
      const res = await fetch(url);
      console.log('Fetch response:', res.status, res.ok);
      if (!res.ok) continue;
      const text = await res.text();
      console.log('Text length:', text.length);
      console.log('First 200 chars:', text.substring(0, 200));
      if (text.length < 100) continue;
      // Destroy existing charts before re-rendering
      if (cumulativeChart) { cumulativeChart.destroy(); cumulativeChart = null; }
      if (dailyChart) { dailyChart.destroy(); dailyChart = null; }
      console.log('Parsing CSV...');
      parseCSV(text);
      console.log('Parsed trades:', allTrades.length);
      
      // Load balance data
      await loadBalanceData();
      
      console.log('Rendering...');
      renderAll();
      console.log('Done!');
      statusEl.style.display = 'none';
      successEl.style.display = 'inline';
      return; // Stop after first success
    } catch(e) {
      console.error('Error loading from', url, ':', e);
      continue;
    }
  }

  console.error('Failed to load from all URLs');
  statusEl.textContent = '⚠ Failed to load data';
  statusEl.style.color = 'var(--red)';
}

async function loadBalanceData() {
  const urls = [BALANCE_PUB_URL, BALANCE_GVIZ_URL];
  
  for (const url of urls) {
    try {
      const res = await fetch(url);
      if (!res.ok) continue;
      const text = await res.text();
      if (text.length < 50) continue;
      
      parseBalanceCSV(text);
      populateAccountDropdown();
      return;
    } catch(e) {
      console.error('Error loading balance data from', url, ':', e);
      continue;
    }
  }
  
  console.warn('Could not load balance data');
}

function parseBalanceCSV(text) {
  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]);
  
  // Find column indices
  const accountIdx = headers.findIndex(h => h.toLowerCase().includes('account'));
  const typeIdx = headers.findIndex(h => h.toLowerCase().includes('type'));
  const amountIdx = headers.findIndex(h => h.toLowerCase().includes('amount'));
  
  accountBalances = {};
  availableAccounts = [];
  
  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    const account = cols[accountIdx];
    const type = cols[typeIdx] ? cols[typeIdx].toLowerCase() : '';
    const amountStr = cols[amountIdx];
    
    if (!account || !amountStr) continue;
    
    // Parse amount
    let amountClean = amountStr.replace(/[$\s]/g, '');
    amountClean = amountClean.replace(/,/g, '');
    const amount = parseFloat(amountClean);
    if (isNaN(amount)) continue;
    
    // Initialize account if not exists
    if (!accountBalances[account]) {
      accountBalances[account] = { deposits: 0, withdrawals: 0 };
      availableAccounts.push(account);
    }
    
    // Add to deposits or withdrawals
    if (type.includes('deposit')) {
      accountBalances[account].deposits += amount;
    } else if (type.includes('withdrawal')) {
      accountBalances[account].withdrawals += amount;
    }
  }
  
  // Calculate starting balance for each account
  for (const account in accountBalances) {
    accountBalances[account].startingBalance = 
      accountBalances[account].deposits - accountBalances[account].withdrawals;
  }
  
  console.log('Account balances:', accountBalances);
}

function populateAccountDropdown() {
  const optionsList = document.getElementById('accountOptionsList');
  optionsList.innerHTML = '';
  
  availableAccounts.forEach((account, index) => {
    const option = document.createElement('div');
    option.className = 'account-option';
    option.setAttribute('data-value', account);
    option.innerHTML = `
      <input type="checkbox" id="account-${index}" />
      <label for="account-${index}">${account}</label>
    `;
    option.onclick = () => selectAccount(account);
    optionsList.appendChild(option);
  });
  
  // Set first account as default
  if (availableAccounts.length > 0) {
    selectedAccount = availableAccounts[0];
    document.getElementById('selectedAccountText').textContent = selectedAccount;
    updateAccountCheckboxes();
    filterByAccount();
  }
}

function toggleAccountDropdown() {
  const dropdown = document.getElementById('accountDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function selectAccount(account) {
  selectedAccount = account;
  document.getElementById('selectedAccountText').textContent = account;
  updateAccountCheckboxes();
  toggleAccountDropdown();
  filterByAccount();
}

function updateAccountCheckboxes() {
  // Uncheck all
  document.getElementById('account-all').checked = false;
  availableAccounts.forEach((_, index) => {
    const checkbox = document.getElementById(`account-${index}`);
    if (checkbox) checkbox.checked = false;
  });
  
  // Check selected
  if (selectedAccount === 'all') {
    document.getElementById('account-all').checked = true;
  } else {
    const index = availableAccounts.indexOf(selectedAccount);
    if (index >= 0) {
      const checkbox = document.getElementById(`account-${index}`);
      if (checkbox) checkbox.checked = true;
    }
  }
}

// Handle "All accounts" selection
document.addEventListener('DOMContentLoaded', () => {
  const allAccountsOption = document.querySelector('[data-value="all"]');
  if (allAccountsOption) {
    allAccountsOption.onclick = () => {
      selectedAccount = 'all';
      document.getElementById('selectedAccountText').textContent = 'All accounts';
      updateAccountCheckboxes();
      toggleAccountDropdown();
      filterByAccount();
    };
  }
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  const wrapper = document.querySelector('.account-dropdown-wrapper');
  const dropdown = document.getElementById('accountDropdown');
  if (wrapper && dropdown && !wrapper.contains(e.target)) {
    dropdown.style.display = 'none';
  }
});

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += ch;
    }
  }
  result.push(current.trim());
  return result;
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]);
  allTrades = [];
  allTradesUnfiltered = [];
  dailyData = {};

  // Find column indices
  // Expecting: Trade ID, Account, Open date, Open Time, Ticker, Direction, Win/Loss, % Risk, % PnL, R, PnL, Learnings
  const dateIdx = headers.findIndex(h => h.toLowerCase().includes('open date') || h.toLowerCase().includes('date'));
  const pnlIdx = headers.findIndex(h => h.toLowerCase() === 'pnl');
  const winlossIdx = headers.findIndex(h => h.toLowerCase().includes('win/loss'));
  const tickerIdx = headers.findIndex(h => h.toLowerCase().includes('ticker'));
  const directionIdx = headers.findIndex(h => h.toLowerCase().includes('direction'));
  const accountIdx = headers.findIndex(h => h.toLowerCase().includes('account'));

  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    const dateStr = cols[dateIdx];
    const pnlStr = cols[pnlIdx];

    if (!dateStr || !pnlStr) continue;

    // Parse PnL: US format only (comma = thousands separator, period = decimal)
    let pnlClean = pnlStr.replace(/[$\s]/g, ''); // Remove $ and spaces
    pnlClean = pnlClean.replace(/,/g, '');       // Remove commas (thousands separator)
    const pnl = parseFloat(pnlClean);
    if (isNaN(pnl)) continue;

    // Parse date: "21 jan 26" or similar
    const date = parseDate(dateStr);
    if (!date) continue;

    const dateKey = formatDateKey(date);
    const winLoss = cols[winlossIdx] ? cols[winlossIdx].toLowerCase() : '';
    const ticker = cols[tickerIdx] || '';
    const direction = cols[directionIdx] || '';

    const trade = { date, dateKey, pnl, winLoss, ticker, direction, account: cols[accountIdx] || 'Unknown' };
    allTrades.push(trade);
    allTradesUnfiltered.push(trade);

    if (!dailyData[dateKey]) {
      dailyData[dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[dateKey].pnl += pnl;
    dailyData[dateKey].tradeCount += 1;
    if (pnl > 0) dailyData[dateKey].wins += 1;
    else if (pnl < 0) dailyData[dateKey].losses += 1;
    else dailyData[dateKey].breakeven += 1;
  }
}

function parseDate(str) {
  // Handle "21 jan 26", "21 jan 2026", etc.
  const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
  const parts = str.trim().split(/[\s\/\-]+/);
  if (parts.length >= 3) {
    let day, month, year;
    // Try "21 jan 26"
    if (isNaN(parts[1]) && months[parts[1].toLowerCase()] !== undefined) {
      day = parseInt(parts[0]);
      month = months[parts[1].toLowerCase()];
      year = parseInt(parts[2]);
      if (year < 100) year += 2000;
    }
    // Try "jan 21 26" or other formats
    else if (isNaN(parts[0]) && months[parts[0].toLowerCase()] !== undefined) {
      month = months[parts[0].toLowerCase()];
      day = parseInt(parts[1]);
      year = parseInt(parts[2]);
      if (year < 100) year += 2000;
    }
    if (day && month !== undefined && year) {
      return new Date(year, month, day);
    }
  }
  // Fallback: try native parse
  const d = new Date(str);
  if (!isNaN(d.getTime())) return d;
  return null;
}

function formatDateKey(date) {
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function formatCurrency(val) {
  const abs = Math.abs(val);
  let str;
  if (abs >= 1000) str = '$' + (abs/1000).toFixed(1) + 'K';
  else str = '$' + abs.toFixed(2);
  return (val < 0 ? '-' : '') + str;
}

function formatCurrencyFull(val) {
  const sign = val < 0 ? '-' : '';
  const abs = Math.abs(val);
  return sign + '$' + abs.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}

// ============================================================
// RENDER ALL
// ============================================================
function renderAll() {
  renderMetrics();
  renderCumulativeChart();
  renderDailyChart();
  renderCalendar();
}

function filterByAccount() {
  // Filter trades by account (selectedAccount is set by selectAccount function)
  if (selectedAccount === 'all') {
    allTrades = [...allTradesUnfiltered];
  } else {
    allTrades = allTradesUnfiltered.filter(t => t.account === selectedAccount);
  }
  
  // Apply date filter if exists
  if (dateFilterFrom || dateFilterTo) {
    allTrades = allTrades.filter(t => {
      if (dateFilterFrom && t.date < dateFilterFrom) return false;
      if (dateFilterTo && t.date > dateFilterTo) return false;
      return true;
    });
  }
  
  // Rebuild dailyData
  dailyData = {};
  allTrades.forEach(t => {
    if (!dailyData[t.dateKey]) {
      dailyData[t.dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[t.dateKey].pnl += t.pnl;
    dailyData[t.dateKey].tradeCount += 1;
    if (t.pnl > 0) dailyData[t.dateKey].wins += 1;
    else if (t.pnl < 0) dailyData[t.dateKey].losses += 1;
    else dailyData[t.dateKey].breakeven += 1;
  });
  
  renderAll();
}

// ============================================================
// METRICS
// ============================================================
function renderMetrics() {
  // Net PnL
  const totalPnl = allTrades.reduce((s,t) => s + t.pnl, 0);
  const pnlEl = document.getElementById('val-pnl');
  pnlEl.textContent = formatCurrencyFull(totalPnl);
  pnlEl.className = 'value ' + (totalPnl >= 0 ? 'positive' : 'negative');

  // Win rate
  const wins = allTrades.filter(t => t.pnl > 0).length;
  const losses = allTrades.filter(t => t.pnl < 0).length;
  const breakeven = allTrades.filter(t => t.pnl === 0).length;
  const total = allTrades.length;
  const winRate = total > 0 ? (wins / total) * 100 : 0;

  document.getElementById('val-winrate').textContent = winRate.toFixed(2) + '%';
  document.getElementById('val-wins').textContent = wins;
  document.getElementById('val-losses').textContent = losses;
  document.getElementById('val-breakeven').textContent = breakeven;

  // Gauge - semicircle showing wins in green and losses in red
  const gaugeArc = document.getElementById('gauge-arc');
  const gaugeArcLoss = document.getElementById('gauge-arc-loss');
  const arcLength = 94.25; // Half circle arc length
  const lossRate = total > 0 ? (losses / total) * 100 : 0;
  
  // Green arc shows wins starting from left
  const winOffset = arcLength * (1 - winRate / 100);
  gaugeArc.style.strokeDashoffset = winOffset;
  
  // Red arc shows losses - needs to be offset to start after wins
  const lossLength = arcLength * (lossRate / 100);
  gaugeArcLoss.style.strokeDasharray = `${lossLength} ${arcLength}`;
  gaugeArcLoss.style.strokeDashoffset = -arcLength * (winRate / 100);

  // Profit Factor
  const grossProfit = allTrades.filter(t=>t.pnl>0).reduce((s,t)=>s+t.pnl,0);
  const grossLoss = Math.abs(allTrades.filter(t=>t.pnl<0).reduce((s,t)=>s+t.pnl,0));
  const pf = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? Infinity : 0);
  const pfEl = document.getElementById('val-pf');
  pfEl.textContent = pf === Infinity ? '∞' : pf.toFixed(2);
  pfEl.className = 'value ' + (pf >= 1 ? 'positive' : 'negative');

  // PF gauge (cap at 3 for visual)
  const pfGauge = document.getElementById('pf-gauge-circle');
  const pfCircumference = 176; // 2 * PI * 28 ≈ 176
  const pfPercent = Math.min(pf / 3, 1);
  pfGauge.style.strokeDashoffset = pfCircumference * (1 - pfPercent);
  pfGauge.style.stroke = pf >= 1 ? '#00c9a7' : '#ff4757';

  // Avg win / loss
  const avgWin = wins > 0 ? grossProfit / wins : 0;
  const avgLoss = losses > 0 ? grossLoss / losses : 0;
  const ratio = avgLoss > 0 ? avgWin / avgLoss : 0;
  
  document.getElementById('val-ratio').textContent = ratio > 0 ? ratio.toFixed(2) : '—';
  document.getElementById('label-avgwin').textContent = formatCurrency(avgWin);
  document.getElementById('label-avgloss').textContent = '-' + formatCurrency(avgLoss);

  // Avg bar ratio
  const winPart = document.querySelector('.avg-bar .win-part');
  const lossPart = document.querySelector('.avg-bar .loss-part');
  const total2 = avgWin + avgLoss;
  if (total2 > 0) {
    winPart.style.flex = (avgWin / total2);
    lossPart.style.flex = (avgLoss / total2);
  }
  
  // Account Balance
  const currentBalanceEl = document.getElementById('val-current-balance');
  if (selectedAccount !== 'all' && accountBalances[selectedAccount]) {
    const accountData = accountBalances[selectedAccount];
    const startingBalance = accountData.startingBalance;
    const tradingPnl = totalPnl;
    const currentBalance = startingBalance + tradingPnl;
    
    currentBalanceEl.textContent = formatCurrencyFull(currentBalance);
    currentBalanceEl.className = 'value ' + (currentBalance >= 0 ? 'positive' : 'negative');
  } else if (selectedAccount === 'all') {
    // Show total across all accounts
    let totalStarting = 0;
    for (const acc in accountBalances) {
      totalStarting += accountBalances[acc].startingBalance;
    }
    const currentBalance = totalStarting + totalPnl;
    currentBalanceEl.textContent = formatCurrencyFull(currentBalance);
    currentBalanceEl.className = 'value ' + (currentBalance >= 0 ? 'positive' : 'negative');
  } else {
    currentBalanceEl.textContent = '—';
    currentBalanceEl.className = 'value';
  }
}

// ============================================================
// CUMULATIVE CHART
// ============================================================
function renderCumulativeChart() {
  // Build sorted daily timeline
  const keys = Object.keys(dailyData).sort();
  if (keys.length === 0) return;

  const labels = [];
  const values = [];
  let cumulative = 0;

  // Generate all dates from first trade to last trade
  const start = new Date(keys[0]);
  const end = new Date(keys[keys.length-1]);
  
  // Add starting point at 0 (day before first trade)
  const dayBeforeStart = new Date(start);
  dayBeforeStart.setDate(dayBeforeStart.getDate() - 1);
  labels.push(dayBeforeStart.getDate() + '/' + (dayBeforeStart.getMonth()+1) + '/' + String(dayBeforeStart.getFullYear()).slice(-2));
  values.push(0);
  
  const d = new Date(start);
  while (d <= end) {
    const key = formatDateKey(d);
    if (dailyData[key]) cumulative += dailyData[key].pnl;
    labels.push(d.getDate() + '/' + (d.getMonth()+1) + '/' + String(d.getFullYear()).slice(-2));
    values.push(cumulative);
    d.setDate(d.getDate()+1);
  }

  const ctx = document.getElementById('cumulativeChart').getContext('2d');
  if (cumulativeChart) cumulativeChart.destroy();

  cumulativeChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        borderColor: 'rgba(142, 142, 142, 0.8)',
        borderWidth: 2,
        pointRadius: 2,
        pointBackgroundColor: 'rgba(142, 142, 142, 0.8)',
        pointBorderColor: 'rgba(142, 142, 142, 0.8)',
        pointHoverRadius: 4,
        pointHoverBackgroundColor: 'rgba(142, 142, 142, 1)',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 2,
        fill: false,
        tension: 0.5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: {
        backgroundColor: '#1a2230',
        titleColor: '#6b7a8d',
        bodyColor: '#eef0f2',
        borderColor: '#1e252e',
        borderWidth: 1,
        titleFont: { family: 'Manrope', size: 11 },
        bodyFont: { family: 'Manrope', size: 13, weight: '600' },
        callbacks: {
          title: function(items) { return items[0].label; },
          label: function(item) { return ' ' + formatCurrencyFull(item.parsed.y); }
        }
      }},
      scales: {
        x: {
          ticks: { color: '#8e8e8e', maxTicksLimit: 8, font: { family: 'Manrope', size: 14 }, maxRotation: 45 },
          grid: { color: 'rgba(30,37,46,0.5)' },
          border: { color: '#1e252e' }
        },
        y: {
          ticks: { color: '#8e8e8e', font: { family: 'Manrope', size: 14 }, callback: v => formatCurrency(v) },
          grid: { color: 'rgba(30,37,46,0.5)' },
          border: { color: '#1e252e' }
        }
      }
    }
  });
}

// ============================================================
// DAILY PNL CHART
// ============================================================
function renderDailyChart() {
  const keys = Object.keys(dailyData).sort();
  if (keys.length === 0) return;

  const labels = keys.map(k => { const p = k.split('-'); return p[2] + '/' + p[1].replace(/^0/,'') + '/' + p[0].slice(-2); });
  const positives = keys.map(k => dailyData[k].pnl > 0 ? dailyData[k].pnl : null);
  const negatives = keys.map(k => dailyData[k].pnl < 0 ? dailyData[k].pnl : null);

  const ctx = document.getElementById('dailyChart').getContext('2d');
  if (dailyChart) dailyChart.destroy();

  dailyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { data: positives, backgroundColor: '#00c9a7', borderRadius: 2 },
        { data: negatives, backgroundColor: '#ff4757', borderRadius: 2 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a2230',
          titleColor: '#6b7a8d',
          bodyColor: '#eef0f2',
          borderColor: '#1e252e',
          borderWidth: 1,
          titleFont: { family: 'Manrope', size: 11 },
          bodyFont: { family: 'Manrope', size: 13, weight: '600' },
          callbacks: {
            title: function(items) { return items[0].label; },
            label: function(item) { return ' ' + formatCurrencyFull(item.parsed.y || 0); }
          },
          filter: function(item) { return item.parsed.y !== null; }
        }
      },
      scales: {
        x: {
          ticks: { color: '#8e8e8e', maxTicksLimit: 8, font: { family: 'Manrope', size: 14 }, maxRotation: 45 },
          grid: { display: false },
          border: { color: '#1e252e' }
        },
        y: {
          ticks: { color: '#8e8e8e', font: { family: 'Manrope', size: 14 }, callback: v => formatCurrency(v) },
          grid: { color: 'rgba(30,37,46,0.5)' },
          border: { color: '#1e252e' }
        }
      }
    }
  });
}

// ============================================================
// CALENDAR
// ============================================================
function renderCalendar() {
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('cal-month-title').textContent = monthNames[calendarMonth] + ' ' + calendarYear;

  const grid = document.getElementById('calendarGrid');
  const sidebar = document.getElementById('weeklySidebar');
  grid.innerHTML = '';
  sidebar.innerHTML = '';

  // Day headers (Mon-Sun)
  const dayHeaders = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  dayHeaders.forEach(d => {
    const h = document.createElement('div');
    h.className = 'cal-header';
    h.textContent = d;
    grid.appendChild(h);
  });
  
  // Add spacer header to sidebar to align with calendar headers
  const sidebarHeader = document.createElement('div');
  sidebarHeader.className = 'cal-header';
  sidebarHeader.style.padding = '8px 0';
  sidebarHeader.style.visibility = 'hidden'; // invisible but takes up space
  sidebar.appendChild(sidebarHeader);

  // First day of month (0=Sun, convert to Mon-based)
  const firstDay = new Date(calendarYear, calendarMonth, 1);
  let startDow = firstDay.getDay(); // 0=Sun
  startDow = startDow === 0 ? 6 : startDow - 1; // Convert to Mon=0

  const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
  const today = new Date();

  // Monthly PnL
  let monthlyPnl = 0;
  let tradingDays = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    const key = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (dailyData[key]) {
      monthlyPnl += dailyData[key].pnl;
      tradingDays++;
    }
  }
  const mpnlEl = document.getElementById('cal-monthly-pnl');
  mpnlEl.textContent = formatCurrency(monthlyPnl);
  mpnlEl.className = 'ms-pnl ' + (monthlyPnl >= 0 ? 'positive' : 'negative');
  document.getElementById('cal-trading-days').textContent = tradingDays + ' days';

  // Empty cells before first day
  for (let i = 0; i < startDow; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day empty';
    grid.appendChild(empty);
  }

  // Track weeks for sidebar - calculate total rows needed (including header row)
  const totalCells = startDow + daysInMonth;
  const totalDayRows = Math.ceil(totalCells / 7);
  const totalWeeks = totalDayRows; // Number of week items needed to match day rows
  const weeks = [];
  let currentWeek = { pnl: 0, tradingDays: 0 };
  let dayOfWeek = startDow;

  for (let d = 1; d <= daysInMonth; d++) {
    const key = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const data = dailyData[key];
    const isToday = (d === today.getDate() && calendarMonth === today.getMonth() && calendarYear === today.getFullYear());

    const cell = document.createElement('div');
    cell.className = 'cal-day';
    if (isToday) cell.classList.add('today');

    if (data) {
      cell.classList.add(data.pnl >= 0 ? 'positive' : 'negative');
      currentWeek.pnl += data.pnl;
      currentWeek.tradingDays++;

      cell.innerHTML = `
        <div class="day-num">${d}</div>
        <div class="day-pnl ${data.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.pnl)}</div>
        <div class="day-meta">${data.tradeCount} trade${data.tradeCount > 1 ? 's' : ''}<br>${data.tradeCount > 0 ? Math.round((data.wins/data.tradeCount)*100) : 0}%</div>
      `;
    } else {
      cell.innerHTML = `<div class="day-num">${d}</div>`;
    }

    grid.appendChild(cell);

    // End of week (Sunday = dayOfWeek 6) or last day
    if (dayOfWeek === 6) {
      weeks.push({...currentWeek});
      currentWeek = { pnl: 0, tradingDays: 0 };
    }
    dayOfWeek = (dayOfWeek + 1) % 7;
  }
  
  // Push final week if it exists
  if (dayOfWeek !== 0) {
    weeks.push({...currentWeek});
  }

  // Render weekly sidebar - ensure we have entries for all rows
  for (let i = 0; i < totalWeeks; i++) {
    const week = weeks[i] || { pnl: 0, tradingDays: 0 };
    const item = document.createElement('div');
    item.className = 'week-item';
    const pnlClass = week.pnl === 0 ? 'neutral' : (week.pnl >= 0 ? 'positive' : 'negative');
    item.innerHTML = `
      <div class="week-label">Week ${i+1}</div>
      <div class="week-pnl ${pnlClass}">${formatCurrency(week.pnl)}</div>
      <div class="week-days">${week.tradingDays} days</div>
    `;
    sidebar.appendChild(item);
  }
}

function changeMonth(dir) {
  calendarMonth += dir;
  if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
  if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
  renderCalendar();
}

function goToThisMonth() {
  calendarMonth = new Date().getMonth();
  calendarYear = new Date().getFullYear();
  renderCalendar();
}

// Initialize - load data after all functions are defined
loadData();
</script>
</div> <!-- Close main-content -->
</div> <!-- Close container -->
</body>
</html>
