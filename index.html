<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  /* ============================================================
     CSS VARIABLES - CodePen-inspired Design System
     ============================================================ */
  :root {
    /* Colors - HSL based like CodePen */
    --color-bg-dark: hsl(0, 0%, 0%);
    --color-bg: hsl(0, 0%, 5%);
    --color-bg-light: hsl(0, 0%, 10%);
    --color-border: hsl(0, 0%, 10%);
    --color-border-light: hsl(0, 0%, 20%);
    --color-text: hsl(0, 0%, 95%);
    --color-text-light: hsl(0, 0%, 75%);
    --color-text-muted: hsl(0, 0%, 55%);
    --color-green: #00c9a7;
    --color-red: #ff4757;
    --color-accent: #00c9a7;
    
    /* Gradients */
    --gradient-card: linear-gradient(0deg, var(--color-bg) 95%, var(--color-bg-light));
    --gradient-card-hover: linear-gradient(0deg, var(--color-bg), var(--color-bg-light));
    
    /* Typography */
    --ff: "Manrope", sans-serif;
    
    /* Spacing - Consistent */
    --rounded: 0.75rem;
    --card-padding: 1.5rem;
    --spacing-xs: 0.5rem;
    --spacing-sm: 1rem;
    --spacing-md: 1.5rem;
    --spacing-lg: 2rem;
    
    /* Shadows */
    --shadow: 0px 2px 4px rgba(0, 0, 0, 0.3);
    
    /* Legacy aliases for compatibility */
    --bg-deep: var(--color-bg-dark);
    --bg-card: var(--color-bg);
    --border: var(--color-border);
    --green: var(--color-green);
    --red: var(--color-red);
    --text-primary: var(--color-text);
    --text-secondary: var(--color-text-light);
    --text-muted: var(--color-text-muted);
    --accent: var(--color-accent);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: var(--ff);
    background: var(--color-bg-dark);
    color: var(--color-text);
    min-height: 100vh;
    margin: 0 auto;
    width: 95%;
    max-width: 1400px;
  }
  
  @media (max-width: 600px) {
    body {
      width: 95%;
    }
  }

  /* Header */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--color-bg-dark);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }
  
  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-sm);
    }
  }
  
  .header h1 {
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .header .subtitle {
    color: var(--text-secondary);
    font-size: 13px;
    margin-top: 2px;
  }
  
  /* Apply button */
  .apply-btn:hover {
    background: var(--gradient-card-hover) !important;
  }
  
  /* Calendar button */
  .calendar-btn:hover {
    background: var(--gradient-card-hover);
  }
  .calendar-btn svg {
    stroke: var(--color-text);
  }
  
  /* Account dropdown */
  .account-dropdown-wrapper {
    position: relative;
  }
  
  .account-btn {
    font-family: Manrope;
    font-size: 12px;
  }
  
  .account-btn:hover {
    background: var(--gradient-card-hover);
  }
  
  .account-btn svg {
    stroke: var(--color-text);
  }
  
  .account-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    border-radius: 8px;
    min-width: 200px;
    box-shadow: var(--shadow);
    padding: 8px 0;
    z-index: 1000;
  }
  
  .account-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .account-option:hover {
    background: var(--color-bg-light);
  }
  
  .account-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--green);
  }
  
  .account-option label {
    cursor: pointer;
    font-size: 13px;
    color: var(--color-text);
    flex: 1;
  }
  
  .account-section-title {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 16px 8px 16px;
    font-weight: 600;
  }
  
  /* Date Picker Dropdown */
  .date-picker-modal {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    z-index: 1000;
    max-width: 95vw;
  }
  .date-picker-content {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    border-radius: var(--rounded);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .date-picker-layout {
    display: flex;
    align-items: stretch;
  }
  .date-picker-left {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-width: 0;
  }
  .date-picker-header {
    padding: 1rem 1.5rem 0.75rem;
    border-bottom: 1px solid var(--color-border);
    flex-shrink: 0;
  }
  .date-picker-header-inner {
    display: flex;
    align-items: center;
  }
  .date-label-from {
    flex: 1;
    text-align: center;
  }
  .date-label-to {
    flex: 1;
    text-align: center;
  }
  .date-label-arrow {
    color: var(--text-muted);
    font-size: 1rem;
    flex-shrink: 0;
    padding: 0 8px;
  }
  .date-display-from,
  .date-display-to {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text);
  }
  .date-picker-body {
    padding: 1.25rem 1.5rem;
    flex: 1;
  }
  .calendars-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
  }
  .presets-container {
    display: flex;
    flex-direction: column;
    width: 160px;
    flex-shrink: 0;
    border-left: 1px solid var(--color-border);
    justify-content: space-evenly;
  }
  .preset-btn {
    background: none;
    border: none;
    color: var(--color-text);
    padding: 0 20px;
    flex: 1;
    display: flex;
    align-items: center;
    font-family: Manrope;
    font-size: 13px;
    cursor: pointer;
    text-align: left;
    transition: background 0.15s ease;
    white-space: nowrap;
  }
  .preset-btn:hover {
    background: var(--color-bg-light);
  }
  .preset-btn.active {
    font-weight: 700;
  }
  .calendar-picker {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .calendar-picker-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }
  .month-year {
    display: flex;
    gap: 0.5rem;
  }
  .month-year select {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    padding: 6px 10px;
    border-radius: 6px;
    font-family: Manrope;
    font-size: 13px;
    cursor: pointer;
  }
  .month-nav {
    background: var(--color-bg-light);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .month-nav:hover {
    background: var(--color-bg);
  }
  /* Fixed 6-row grid — popup never shifts height between months */
  .picker-grid {
    display: grid;
    grid-template-columns: repeat(7, 34px);
    grid-template-rows: 28px repeat(6, 34px);
    gap: 0;
    width: calc(7 * 34px);
  }
  .cal-weekday {
    width: 34px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 600;
  }
  .cal-day-picker {
    width: 34px;
    height: 34px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s ease;
    user-select: none;
  }
  .cal-day-picker:hover:not(.empty):not(.disabled) {
    background: rgba(255,255,255,0.1);
  }
  .cal-day-picker.selected {
    background: rgba(255,255,255,0.2);
    color: var(--color-text);
    font-weight: 600;
    border: 1px solid rgba(255,255,255,0.35);
  }
  .cal-day-picker.in-range {
    background: rgba(255,255,255,0.07);
    border-radius: 0;
  }
  .cal-day-picker.today {
    border: 1px solid var(--color-border-light);
  }
  .cal-day-picker.empty {
    cursor: default;
    pointer-events: none;
  }
  .cal-day-picker.disabled {
    color: var(--text-muted);
    opacity: 0.3;
    cursor: not-allowed;
  }
    /* Hamburger button */
  .hamburger {
    background: none;
    border: none;
    color: var(--color-text);
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background 0.2s ease;
  }
  .hamburger:hover {
    background: var(--color-bg-light);
  }
  .hamburger svg {
    width: 20px;
    height: 20px;
    stroke: var(--color-text);
  }
  
  /* Container for sidebar + main content */
  .container {
    display: flex;
    gap: 2rem;
    position: relative;
    margin-top: 1rem;
  }
  
  .main-content {
    flex: 1;
    min-width: 0;
  }
  
  /* Sidebar */
  .sidebar {
    position: sticky;
    top: 80px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    align-self: flex-start;
    width: 200px;
    flex-shrink: 0;
    z-index: 10;
  }
  .show-sidebar {
    display: flex !important;
  }
  .hide-sidebar {
    display: none !important;
  }
  .sidebar-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: var(--color-text-light);
    text-decoration: none;
    border-radius: var(--rounded);
    transition: background 0.2s ease;
    font-size: 14px;
    cursor: default;
  }
  .sidebar-link:hover {
    background: var(--color-bg-light);
  }
  .sidebar-link.active-link {
    color: var(--color-text);
    font-weight: 600;
  }
  .sidebar-link.active-link svg {
    stroke-width: 2.5;
  }
  .sidebar-link svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    flex-shrink: 0;
  }
  
  @media (max-width: 800px) {
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      background: var(--color-bg-dark);
      padding: 80px 20px 20px 20px;
      z-index: 99;
      box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    }
  }

  /* Config input for CSV URL */
  .config-bar {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 24px;
  }
  .config-bar input {
    flex:1;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 8px 14px;
    border-radius: 8px;
    font-family: var(--ff);
    font-size: 12px;
    outline: none;
  }
  .config-bar input:focus { border-color: var(--accent); }
  .config-bar button {
    background: var(--accent);
    color: #0a0c0f;
    border: none;
    padding: 8px 18px;
    border-radius: 8px;
    font-family: var(--ff);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
  }
  .config-bar button:hover { opacity: 0.85; }

  /* Metric Cards */
  .metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  @media (min-width: 1200px) {
    .metrics-row {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  
  .metric-card {
    background: var(--gradient-card);
    border: 1px solid var(--color-border);\n    border-top: 1px solid var(--color-border-light);
    box-shadow: var(--shadow);
    border-radius: var(--rounded);
    padding: var(--card-padding);
    position: relative;
    overflow: hidden;
    transition: background 0.2s ease;
  }
  .metric-card:hover {
    background: var(--gradient-card-hover);
  }
  .metric-card .label {
    font-size: 0.75rem;
    color: var(--color-text-light);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-xs);
  }
  .metric-card .value {
    font-size: 26px;
    font-weight: 700;
    letter-spacing: -1px;
  }
  .metric-card .value.positive { color: var(--green); }
  .metric-card .value.negative { color: var(--red); }

  /* Gauge styles */
  .gauge-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-top: 4px;
  }
  .gauge-svg { width: 64px; height: 64px; }
  .gauge-stats { display: flex; gap: 12px; }
  .gauge-stat { font-size: 11px; }
  .gauge-stat .gs-val { font-weight: 600; font-size: 13px; }
  .gauge-stat.win .gs-val { color: var(--green); }
  .gauge-stat.loss .gs-val { color: var(--red); }
  .gauge-stat.neutral .gs-val { color: var(--text-secondary); }

  /* Avg win/loss bar */
  .avg-bar {
    display: flex;
    margin-top: 10px;
    height: 6px;
    border-radius: 3px;
    overflow: hidden;
    gap: 3px;
  }
  .avg-bar .win-part { background: var(--green); flex: 1; border-radius: 3px; }
  .avg-bar .loss-part { background: var(--red); flex: 1; border-radius: 3px; }
  .avg-bar-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
  }
  .avg-bar-labels span { font-size: 11px; font-weight: 500; }
  .avg-bar-labels .win-label { color: var(--green); }
  .avg-bar-labels .loss-label { color: var(--red); }

  /* Charts Row */
  .charts-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(400px, 100%), 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  
  .chart-card {
    background: var(--gradient-card);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    box-shadow: var(--shadow);
    border-radius: var(--rounded);
    padding: var(--card-padding);
    transition: background 0.2s ease;
    min-height: 280px;
  }
  .chart-card:hover {
    background: var(--gradient-card-hover);
  }
  .chart-card .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
  }
  .chart-card .chart-title {
    font-size: 12px;
    font-weight: 500;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .chart-card canvas { 
    width: 100% !important; 
    height: max(200px, 20vh) !important;
  }
  
  @media (min-width: 768px) {
    .chart-card canvas {
      height: 220px !important;
    }
  }

  /* Calendar */
  .calendar-section {
    background: var(--gradient-card);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    box-shadow: var(--shadow);
    border-radius: var(--rounded);
    padding: 24px;
    margin-bottom: 24px;
    overflow-x: auto;
  }
  
  @media (max-width: 768px) {
    .calendar-section {
      padding: 16px;
    }
  }
  .calendar-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .calendar-nav .nav-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .calendar-nav .month-title {
    font-size: 16px;
    font-weight: 600;
  }
  .nav-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-primary);
    width: 30px; height: 30px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex; align-items: center; justify-content: center;
  }
  .nav-btn:hover { background: var(--bg-card-hover); }
  .this-month-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    font-family: var(--ff);
  }
  .this-month-btn:hover { background: var(--bg-card-hover); }
  .monthly-stats {
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .monthly-stats .ms-pnl { font-weight: 600; font-size: 16px; }
  .monthly-stats .ms-pnl.positive { color: var(--green); }
  .monthly-stats .ms-pnl.negative { color: var(--red); }
  .monthly-stats .ms-days { color: var(--text-muted); font-size: 12px; }

  .calendar-grid-wrapper {
    display: flex;
    gap: 16px;
    align-items: stretch;
  }

  .calendar-grid {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    min-width: 0;
    align-content: start;
  }

  .weekly-sidebar {
    width: 120px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .cal-header {
    font-size: 11px;
    color: var(--text-muted);
    text-align: center;
    padding: 8px 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .cal-day {
    background: var(--color-bg-light);
    border-radius: var(--rounded);
    padding: var(--spacing-xs);
    min-height: 100px;
    position: relative;
    border: 1px solid transparent;
    transition: background 0.15s ease, border-color 0.15s ease, transform 0.15s ease;
  }
  .cal-day.positive { background: rgba(0,201,167,0.08); border-color: rgba(0,201,167,0.2); }
  .cal-day.negative { background: rgba(255,71,87,0.08); border-color: rgba(255,71,87,0.2); }
  .cal-day.positive:hover { background: rgba(0,201,167,0.15); border-color: rgba(0,201,167,0.4); }
  .cal-day.negative:hover { background: rgba(255,71,87,0.15); border-color: rgba(255,71,87,0.4); }
  .cal-day:not(.positive):not(.negative):not(.empty):hover { background: #222; }
  .cal-day .day-num {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 4px;
    text-align: right;
  }
  .cal-day.today .day-num { 
    width: 24px;
    height: 24px;
    line-height: 24px;
    color: var(--color-bg-dark);
    font-weight: 600;
    background: #ffffff;
    border-radius: 50%;
    text-align: center;
    display: block;
    margin-left: auto;
    margin-bottom: 4px;
  }
  .cal-day .day-pnl {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }
  .cal-day .day-pnl.positive { color: var(--green); }
  .cal-day .day-pnl.negative { color: var(--red); }
  .cal-day .day-meta {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 2px;
    line-height: 1.4;
  }

  /* Weekly sidebar */
  .weekly-sidebar {
    width: 120px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .week-item {
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--rounded);
    padding: var(--spacing-xs);
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: center;
  }
  .week-item:last-child {
    margin-bottom: 0;
  }
  .week-item .week-label {
    font-size: 0.6875rem;
    color: var(--color-text-muted);
    margin-bottom: 3px;
  }
  .week-item .week-pnl {
    font-size: 14px;
    font-weight: 600;
  }
  .week-item .week-pnl.positive { color: var(--green); }
  .week-item .week-pnl.negative { color: var(--red); }
  .week-item .week-pnl.neutral { color: var(--text-muted); }
  .week-item .week-days {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* Loading */

  /* Empty state for calendar days */
  .cal-day.empty { opacity: 0.3; }

  /* Chart expand button */
  .chart-expand-btn {
    background: none;
    border: 1px solid var(--color-border);
    color: var(--text-muted);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.15s ease, color 0.15s ease;
    flex-shrink: 0;
  }
  .chart-expand-btn:hover {
    background: var(--color-bg-light);
    color: var(--color-text);
    border-color: var(--color-border-light);
  }
  .chart-expand-popup {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    border-radius: var(--rounded);
    width: 90vw;
    max-width: 1000px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .chart-expand-popup .chart-expand-body {
    padding: 1rem 1.4rem 1.4rem;
    height: 420px;
    position: relative;
  }
  .chart-expand-popup canvas {
    width: 100% !important;
    height: 100% !important;
  }


  .day-popup-table td.positive { color: var(--green); font-weight: 600; }
  .day-popup-table td.negative { color: var(--red); font-weight: 600; }
  .footer-pnl.positive { color: var(--green); }
  .footer-pnl.negative { color: var(--red); }

  .day-popup-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.55); z-index: 2000;
    display: flex; align-items: center; justify-content: center;
  }
  .day-popup {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border-light);
    border-radius: var(--rounded);
    min-width: 420px;
    max-width: 560px;
    width: 90%;
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .day-popup-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.1rem 1.4rem;
    border-bottom: 1px solid var(--color-border);
  }
  .day-popup-title { font-size: 0.95rem; font-weight: 700; }
  .day-popup-close:hover { background: var(--color-bg-light); color: var(--color-text); }
  .day-popup-table { width: 100%; border-collapse: collapse; }
  .day-popup-table thead { background: var(--color-bg-light); }
  .day-popup-table th {
    padding: 9px 14px; text-align: left;
    font-size: 0.68rem; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: 0.5px;
    font-weight: 600; white-space: nowrap;
  }
  .day-popup-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.875rem;
  }
  .day-popup-table tbody tr:last-child td { border-bottom: none; }
  .day-popup-table tbody tr:hover { background: rgba(255,255,255,0.02); }
  .day-popup-footer {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.85rem 1.4rem;
    border-top: 1px solid var(--color-border-light);
    font-size: 0.875rem;
  }
  .day-popup-footer .footer-label { color: var(--text-muted); font-size: 0.8rem; }
  .day-popup-footer .footer-pnl { font-weight: 700; font-size: 1rem; }

</style>
</head>
<body>

<div class="header">
  <div style="display:flex; align-items:center; gap:16px;">
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="4" x2="20" y1="12" y2="12" />
        <line x1="4" x2="20" y1="6" y2="6" />
        <line x1="4" x2="20" y1="18" y2="18" />
      </svg>
    </button>
    <h1>Trading Dashboard</h1>
  </div>
  <div style="display:flex; gap:12px; align-items:center;">

    <!-- Date Picker Button + Dropdown -->
    <div class="pos-relative">
      <div style="position:relative; display:none; align-items:center; gap:4px;" id="calendarBtnWrapper">
        <button onclick="toggleDatePicker()" id="calendarBtn" style="background:var(--gradient-card);border:1px solid var(--color-border);border-top:1px solid var(--color-border-light);color:var(--color-text);padding:8px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:Manrope;font-size:12px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span id="dateRangeText">All time</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        <button id="clearFilterBtn" onclick="clearDateFilter()" title="Clear filter" style="display:none;background:var(--color-bg-light);border:1px solid var(--color-border);color:var(--text-muted);padding:6px 8px;border-radius:8px;cursor:pointer;font-size:12px;line-height:1;font-family:Manrope;" onmouseover="this.style.color='var(--color-text)'" onmouseout="this.style.color='var(--text-muted)'">✕</button>
      </div>
      <div id="datePickerModal" class="date-picker-modal" style="display:none;">
        <div class="date-picker-content" onclick="event.stopPropagation()">
          <div class="date-picker-layout">
            <div class="date-picker-left">
              <div class="date-picker-header">
                <div class="date-picker-header-inner">
                  <div class="date-label-from">
                    <span id="displayFromDate" class="date-display-from">Select start</span>
                  </div>
                  <div class="date-label-arrow">→</div>
                  <div class="date-label-to">
                    <span id="displayToDate" class="date-display-to">Select end</span>
                  </div>
                </div>
              </div>
              <div class="date-picker-body">
                <div class="calendars-container">
                  <div class="calendar-picker">
                    <div class="calendar-picker-header">
                      <button onclick="prevMonth('from')" class="month-nav">‹</button>
                      <div class="month-year">
                        <select id="fromMonth" onchange="updateFromCalendar()"></select>
                        <select id="fromYear" onchange="updateFromCalendar()"></select>
                      </div>
                      <button onclick="nextMonth('from')" class="month-nav">›</button>
                    </div>
                    <div class="picker-grid" id="fromCalendar">
                      <div class="cal-weekday">Su</div>
                      <div class="cal-weekday">Mo</div>
                      <div class="cal-weekday">Tu</div>
                      <div class="cal-weekday">We</div>
                      <div class="cal-weekday">Th</div>
                      <div class="cal-weekday">Fr</div>
                      <div class="cal-weekday">Sa</div>
                    </div>
                  </div>
                  <div class="calendar-picker" id="toCalendarWrapper">
                    <div class="calendar-picker-header">
                      <button onclick="prevMonth('to')" class="month-nav">‹</button>
                      <div class="month-year">
                        <select id="toMonth" onchange="updateToCalendar()"></select>
                        <select id="toYear" onchange="updateToCalendar()"></select>
                      </div>
                      <button onclick="nextMonth('to')" class="month-nav">›</button>
                    </div>
                    <div class="picker-grid" id="toCalendar">
                      <div class="cal-weekday">Su</div>
                      <div class="cal-weekday">Mo</div>
                      <div class="cal-weekday">Tu</div>
                      <div class="cal-weekday">We</div>
                      <div class="cal-weekday">Th</div>
                      <div class="cal-weekday">Fr</div>
                      <div class="cal-weekday">Sa</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="presets-container">
              <button onclick="applyPreset('today')" class="preset-btn">Today</button>
              <button onclick="applyPreset('week')" class="preset-btn">This week</button>
              <button onclick="applyPreset('month')" class="preset-btn">This month</button>
              <button onclick="applyPreset('30days')" class="preset-btn">Last 30 days</button>
              <button onclick="applyPreset('lastmonth')" class="preset-btn">Last month</button>
              <button onclick="applyPreset('quarter')" class="preset-btn">This quarter</button>
              <button onclick="applyPreset('ytd')" class="preset-btn">YTD (year to date)</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- end calendar relative wrapper -->

    <!-- Account Dropdown -->
    <div class="account-dropdown-wrapper">
      <button onclick="toggleAccountDropdown()" id="accountBtn" style="background:var(--gradient-card);border:1px solid var(--color-border);border-top:1px solid var(--color-border-light);color:var(--color-text);padding:8px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:Manrope;font-size:12px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span id="selectedAccountText">My Account</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </button>
      <div class="account-dropdown" id="accountDropdown" style="display:none;">
        <div class="account-section-title">My accounts</div>
        <div id="accountOptionsList"></div>
      </div>
    </div>

  </div>
</div>

<div style="display:flex; gap:2rem;">
<aside class="sidebar hide-sidebar">
  <a href="index.html" class="sidebar-link active-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8" />
      <path d="M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
    </svg>
    Home
  </a>
  <a href="trades.html" class="sidebar-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 3v16a2 2 0 0 0 2 2h16" />
      <path d="M7 16c.5-2 1.5-7 4-7 2 0 2 3 4 3 2.5 0 4.5-5 5-7" />
    </svg>
    Trades
  </a>
  <a href="javascript:void(0)" class="sidebar-link">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
      <circle cx="12" cy="12" r="3" />
    </svg>
    Settings
  </a>
</aside>

<div class="main-content">

<div class="config-bar">
  <span id="loadStatus" style="color:var(--text-muted);font-size:12px;">Loading trade data...</span>
</div>

<!-- Metric Cards -->
<div class="metrics-row" style="grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));">
  <div class="metric-card" id="card-balance">
    <div class="label">Account balance</div>
    <div class="value" id="val-current-balance" style="margin-top:4px;">—</div>
  </div>
  <div class="metric-card" id="card-pnl">
    <div class="label">Net P&L </div>
    <div style="display:flex; align-items:baseline; gap:8px;">
      <div class="value" id="val-pnl">—</div>
      <div id="val-pnl-percent" style="font-size:14px; color:var(--text-muted);">—</div>
    </div>
  </div>
  <div class="metric-card" id="card-winrate" class="pos-relative">
    <div style="position:absolute; top:50%; right:var(--card-padding); transform:translateY(-50%); display:flex; flex-direction:column; align-items:center;">
      <svg class="gauge-svg" viewBox="0 0 80 40" style="width:90px; height:45px;">
        <path d="M 10 35 A 30 30 0 0 1 70 35" fill="none" stroke="hsl(0,0%,10%)" stroke-width="6" stroke-linecap="round"/>
        <path d="M 10 35 A 30 30 0 0 1 70 35" fill="none" stroke="#ff4757" stroke-width="6" stroke-linecap="round" id="gauge-arc-loss" stroke-dasharray="94.25" stroke-dashoffset="0"/>
        <path d="M 10 35 A 30 30 0 0 1 70 35" fill="none" stroke="#00c9a7" stroke-width="6" stroke-linecap="round" id="gauge-arc" stroke-dasharray="94.25" stroke-dashoffset="94.25"/>
      </svg>
      <div class="gauge-stats" style="margin-top:8px;">
        <div class="gauge-stat win"><div class="gs-val" id="val-wins">0</div></div>
        <div class="gauge-stat neutral"><div class="gs-val" id="val-breakeven">0</div></div>
        <div class="gauge-stat loss"><div class="gs-val" id="val-losses">0</div></div>
      </div>
    </div>
    <div class="label">Trade win %</div>
    <div class="value" id="val-winrate" style="margin-top:4px;">—</div>
  </div>
  <div class="metric-card" id="card-pf" class="pos-relative">
    <div style="position:absolute; top:50%; right:var(--card-padding); transform:translateY(-50%); display:flex; justify-content:center;">
      <svg class="gauge-svg" viewBox="0 0 64 64" style="width:70px; height:70px;">
        <circle cx="32" cy="32" r="28" fill="none" stroke="hsl(0,0%,10%)" stroke-width="6" stroke-linecap="round" stroke-dasharray="176" stroke-dashoffset="0" transform="rotate(-90 32 32)"/>
        <circle cx="32" cy="32" r="28" fill="none" stroke="hsl(0,0%,20%)" stroke-width="6" stroke-linecap="round" stroke-dasharray="176" stroke-dashoffset="176" id="pf-gauge-circle" transform="rotate(-90 32 32)"/>
      </svg>
    </div>
    <div class="label">Profit factor</div>
    <div class="value" id="val-pf" style="margin-top:4px;">—</div>
  </div>
  <div class="metric-card" id="card-avg">
    <div class="label">Avg win / loss trade</div>
    <div style="display:flex; align-items:center; gap:16px; margin-top:4px;">
      <div class="value" id="val-ratio" style="font-size:26px; white-space:nowrap;">—</div>
      <div style="flex:1; min-width:100px;">
        <div class="avg-bar" id="avg-bar"><div class="win-part"></div><div class="loss-part"></div></div>
        <div class="avg-bar-labels">
          <span class="win-label" id="label-avgwin">—</span>
          <span class="loss-label" id="label-avgloss">—</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="charts-row">
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">Daily net cumulative P&L</div>
      <button class="chart-expand-btn" onclick="expandChart('cumulativeChart', 'Daily net cumulative P&L')" title="Expand">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline>
          <line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line>
        </svg>
      </button>
    </div>
    <canvas id="cumulativeChart" height="220"></canvas>
  </div>
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">Net daily P&L</div>
      <button class="chart-expand-btn" onclick="expandChart('dailyChart', 'Net daily P&L')" title="Expand">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline>
          <line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line>
        </svg>
      </button>
    </div>
    <canvas id="dailyChart" height="220"></canvas>
  </div>
</div>

<!-- Calendar -->
<div class="calendar-section">
  <div class="calendar-nav">
    <div class="nav-left">
      <button class="nav-btn" onclick="changeMonth(-1)">&#8592;</button>
      <span class="month-title" id="cal-month-title">January 2026</span>
      <button class="nav-btn" onclick="changeMonth(1)">&#8594;</button>
      <button class="this-month-btn" onclick="goToThisMonth()">This month</button>
    </div>
    <div class="monthly-stats">
      <span class="ms-pnl positive" id="cal-monthly-pnl">$0</span>
      <span class="ms-days" id="cal-trading-days">0 days</span>
    </div>
  </div>
  <div class="calendar-grid-wrapper">
    <div class="calendar-grid" id="calendarGrid"></div>
    <div class="weekly-sidebar" id="weeklySidebar"></div>
  </div>
</div>

<!-- Chart expand popup -->
<div id="chartExpandOverlay" class="day-popup-overlay" style="display:none;" onclick="closeChartExpand(event)">
  <div class="chart-expand-popup" onclick="event.stopPropagation()">
    <div class="day-popup-header" style="padding:1rem 1.4rem;">
      <span class="day-popup-title" id="chartExpandTitle">Chart</span>
    </div>
    <div class="chart-expand-body">
      <canvas id="expandedChart"></canvas>
    </div>
  </div>
</div>

<!-- Day trades popup -->
<div id="dayPopupOverlay" class="day-popup-overlay" style="display:none;" onclick="closeDayPopup(event)">
  <div class="day-popup" onclick="event.stopPropagation()">
    <div class="day-popup-header">
      <span class="day-popup-title" id="dayPopupTitle">Trades</span>
    </div>
    <table class="day-popup-table">
      <thead>
        <tr>
          <th>Ticker</th>
          <th>Direction</th>
          <th>ROI</th>
          <th>R</th>
          <th>Net P&L</th>
        </tr>
      </thead>
      <tbody id="dayPopupTrades"></tbody>
    </table>
    <div class="day-popup-footer" id="dayPopupFooter"></div>
  </div>
</div>

<script>
// ============================================================
// SIDEBAR TOGGLE
// ============================================================
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  sidebar.classList.toggle('show-sidebar');
  sidebar.classList.toggle('hide-sidebar');
}

// Initialize sidebar visibility based on screen size
window.addEventListener('DOMContentLoaded', () => {
  const sidebar = document.querySelector('.sidebar');
  // Always start collapsed
  sidebar.classList.remove('show-sidebar');
  sidebar.classList.add('hide-sidebar');
});

// Handle sidebar on window resize
// Resize handler removed - sidebar stays in user's chosen state

// ============================================================
// DATA STORE
// ============================================================
let allTrades = [];
let allTradesUnfiltered = []; // Store original unfiltered data
let dailyData = {}; // { "2026-01-21": { pnl, tradeCount, wins, losses } }
let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();
let cumulativeChart = null;
let dailyChart = null;
let dateFilterFrom = null;
let dateFilterTo = null;

// Account tracking
let selectedAccount = 'Breakout 100K'; // Default to first account
let availableAccounts = [];

// ============================================================
// DATE FILTER
// ============================================================
// Date Picker State
let pickerFromDate = null;
let pickerToDate = null;
let pickerSelectionPhase = 1; // 1 = picking start, 2 = picking end
let fromMonth = new Date().getMonth();
let fromYear = new Date().getFullYear();
let toMonth = new Date().getMonth() + 1;
let toYear = new Date().getFullYear();

if (toMonth > 11) {
  toMonth = 0;
  toYear++;
}

function toggleDatePicker() {
  const modal = document.getElementById('datePickerModal');
  const isOpening = modal.style.display === 'none';
  modal.style.display = isOpening ? 'block' : 'none';
  
  if (isOpening) {
    initializeDatePicker();
  }
}

function closeDatePicker() {
  document.getElementById('datePickerModal').style.display = 'none';
}

function initializeDatePicker() {
  pickerSelectionPhase = 1;
  pickerFromDate = dateFilterFrom || null;
  pickerToDate = dateFilterTo || null;

  const today = new Date();
  // Default: left = previous month, right = current month
  if (!pickerFromDate && !pickerToDate) {
    fromMonth = today.getMonth() === 0 ? 11 : today.getMonth() - 1;
    fromYear = today.getMonth() === 0 ? today.getFullYear() - 1 : today.getFullYear();
    toMonth = today.getMonth();
    toYear = today.getFullYear();
  } else {
    fromMonth = pickerFromDate ? pickerFromDate.getMonth() : today.getMonth() - 1;
    fromYear = pickerFromDate ? pickerFromDate.getFullYear() : today.getFullYear();
    toMonth = pickerToDate ? pickerToDate.getMonth() : today.getMonth();
    toYear = pickerToDate ? pickerToDate.getFullYear() : today.getFullYear();
    ensureCalendarSeparation();
  }

  // Always show both calendars
  document.getElementById('toCalendarWrapper').style.display = '';

  populateMonthYearSelects();
  updateBothCalendars();
  updateDateDisplay();
}

function populateMonthYearSelects() {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const currentYear = new Date().getFullYear();
  
  // From month
  const fromMonthSelect = document.getElementById('fromMonth');
  fromMonthSelect.innerHTML = months.map((m, i) => 
    `<option value="${i}" ${i === fromMonth ? 'selected' : ''}>${m}</option>`
  ).join('');
  
  // From year
  const fromYearSelect = document.getElementById('fromYear');
  const years = [];
  for (let y = currentYear - 5; y <= currentYear + 1; y++) {
    years.push(y);
  }
  fromYearSelect.innerHTML = years.map(y => 
    `<option value="${y}" ${y === fromYear ? 'selected' : ''}>${y}</option>`
  ).join('');
  
  // To month
  const toMonthSelect = document.getElementById('toMonth');
  toMonthSelect.innerHTML = months.map((m, i) => 
    `<option value="${i}" ${i === toMonth ? 'selected' : ''}>${m}</option>`
  ).join('');
  
  // To year
  const toYearSelect = document.getElementById('toYear');
  toYearSelect.innerHTML = years.map(y => 
    `<option value="${y}" ${y === toYear ? 'selected' : ''}>${y}</option>`
  ).join('');
}

function updateFromCalendar() {
  fromMonth = parseInt(document.getElementById('fromMonth').value);
  fromYear = parseInt(document.getElementById('fromYear').value);
  ensureCalendarSeparation();
  populateMonthYearSelects();
  updateBothCalendars();
}

function updateToCalendar() {
  toMonth = parseInt(document.getElementById('toMonth').value);
  toYear = parseInt(document.getElementById('toYear').value);
  // Ensure right is always after left
  const fromTotal = fromYear * 12 + fromMonth;
  const toTotal = toYear * 12 + toMonth;
  if (toTotal <= fromTotal) {
    toMonth = fromMonth + 1 > 11 ? 0 : fromMonth + 1;
    toYear = fromMonth + 1 > 11 ? fromYear + 1 : fromYear;
  }
  populateMonthYearSelects();
  updateBothCalendars();
}

function updateBothCalendars() {
  renderPickerCalendar('from', fromMonth, fromYear);
  renderPickerCalendar('to', toMonth, toYear);
}

function prevMonth(type) {
  if (type === 'from') {
    fromMonth--;
    if (fromMonth < 0) { fromMonth = 11; fromYear--; }
    ensureCalendarSeparation();
  } else {
    toMonth--;
    if (toMonth < 0) { toMonth = 11; toYear--; }
    // Don't let right go to same or earlier month as left
    const fromTotal = fromYear * 12 + fromMonth;
    const toTotal = toYear * 12 + toMonth;
    if (toTotal <= fromTotal) {
      toMonth = fromMonth + 1 > 11 ? 0 : fromMonth + 1;
      toYear = fromMonth + 1 > 11 ? fromYear + 1 : fromYear;
    }
  }
  populateMonthYearSelects();
  updateBothCalendars();
}

function nextMonth(type) {
  if (type === 'from') {
    fromMonth++;
    if (fromMonth > 11) { fromMonth = 0; fromYear++; }
    ensureCalendarSeparation();
  } else {
    toMonth++;
    if (toMonth > 11) { toMonth = 0; toYear++; }
  }
  populateMonthYearSelects();
  updateBothCalendars();
}

function renderPickerCalendar(type, month, year) {
  const container = document.getElementById(type === 'from' ? 'fromCalendar' : 'toCalendar');

  // Clear all non-weekday cells
  Array.from(container.children).forEach(child => {
    if (!child.classList.contains('cal-weekday')) child.remove();
  });

  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const fragment = document.createDocumentFragment();

  // Always render exactly 42 cells (6 rows × 7 cols)
  for (let cell = 0; cell < 42; cell++) {
    const dayNum = cell - firstDay + 1;
    const el = document.createElement('div');

    if (dayNum < 1 || dayNum > daysInMonth) {
      // Empty filler cell — no text, no click
      el.className = 'cal-day-picker empty';
    } else {
      const date = new Date(year, month, dayNum);
      date.setHours(0, 0, 0, 0);
      const classes = ['cal-day-picker'];

      if (date.getTime() === today.getTime()) classes.push('today');

      // Highlight logic — suppress on right cal when range is entirely in left cal's month
      const isRightCal = (type === 'to');
      const rangeInLeftOnly = pickerFromDate && pickerToDate &&
        pickerFromDate.getFullYear() === fromYear && pickerFromDate.getMonth() === fromMonth &&
        pickerToDate.getFullYear() === fromYear && pickerToDate.getMonth() === fromMonth;

      if (!(isRightCal && rangeInLeftOnly)) {
        if (pickerFromDate && date.getTime() === pickerFromDate.getTime()) classes.push('selected');
        if (pickerToDate && date.getTime() === pickerToDate.getTime()) classes.push('selected');
        if (pickerFromDate && pickerToDate && date > pickerFromDate && date < pickerToDate) classes.push('in-range');
      }

      el.className = classes.join(' ');
      el.textContent = dayNum;

      // Capture values explicitly to avoid closure issues
      const d = dayNum, m = month, y = year, t = type;
      el.addEventListener('click', function(e) {
        e.stopPropagation();
        selectDate(t, y, m, d);
      });
    }

    fragment.appendChild(el);
  }

  container.appendChild(fragment);
}

function selectDate(type, year, month, day) {
  const selected = new Date(year, month, day);
  selected.setHours(0, 0, 0, 0);

  if (pickerSelectionPhase === 1) {
    // First click: set start date, clear end date
    pickerFromDate = selected;
    pickerToDate = null;
    pickerSelectionPhase = 2;
    updateBothCalendars();
    updateDateDisplay();
  } else {
    // Second click: set end date (ensure from <= to)
    if (selected < pickerFromDate) {
      pickerToDate = pickerFromDate;
      pickerFromDate = selected;
    } else {
      pickerToDate = selected;
    }
    pickerSelectionPhase = 1;
    // Ensure right calendar is always at least one month ahead of left
    ensureCalendarSeparation();
    updateBothCalendars();
    updateDateDisplay();
    // Auto-apply
    applyDateFilterFromPicker();
  }
}

function ensureCalendarSeparation() {
  // Right calendar must always be at least one month after left calendar
  let fromM = fromMonth, fromY = fromYear;
  let toM = toMonth, toY = toYear;

  // Compute "from + 1 month"
  let minToM = fromM + 1;
  let minToY = fromY;
  if (minToM > 11) { minToM = 0; minToY++; }

  // If to is same or earlier than from, push to to be one month ahead
  const fromTotal = fromY * 12 + fromM;
  const toTotal = toY * 12 + toM;
  if (toTotal <= fromTotal) {
    toMonth = minToM;
    toYear = minToY;
  }
}

function updateDateDisplay() {
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  const fromText = pickerFromDate ? pickerFromDate.toLocaleDateString('en-US', options) : 'Select start';
  const toText = pickerToDate ? pickerToDate.toLocaleDateString('en-US', options) : (pickerSelectionPhase === 2 ? 'Select end' : 'Select start');
  document.getElementById('displayFromDate').textContent = fromText;
  document.getElementById('displayToDate').textContent = toText;
}

function applyPreset(preset) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  switch(preset) {
    case 'today':
      pickerFromDate = new Date(today);
      pickerToDate = new Date(today);
      break;
    case 'week':
      const dayOfWeek = today.getDay();
      pickerFromDate = new Date(today);
      pickerFromDate.setDate(today.getDate() - dayOfWeek);
      pickerToDate = new Date(today);
      break;
    case 'month':
      pickerFromDate = new Date(today.getFullYear(), today.getMonth(), 1);
      pickerToDate = new Date(today);
      break;
    case '30days':
      pickerFromDate = new Date(today);
      pickerFromDate.setDate(today.getDate() - 30);
      pickerToDate = new Date(today);
      break;
    case 'lastmonth':
      pickerFromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
      pickerToDate = new Date(today.getFullYear(), today.getMonth(), 0);
      break;
    case 'quarter':
      const quarter = Math.floor(today.getMonth() / 3);
      pickerFromDate = new Date(today.getFullYear(), quarter * 3, 1);
      pickerToDate = new Date(today);
      break;
    case 'ytd':
      pickerFromDate = new Date(today.getFullYear(), 0, 1);
      pickerToDate = new Date(today);
      break;
  }
  
  fromMonth = pickerFromDate.getMonth();
  fromYear = pickerFromDate.getFullYear();
  toMonth = pickerToDate.getMonth();
  toYear = pickerToDate.getFullYear();

  // Always keep both calendars visible, right always >= 1 month ahead of left
  document.getElementById('toCalendarWrapper').style.display = '';
  ensureCalendarSeparation();
  pickerSelectionPhase = 1;

  populateMonthYearSelects();
  updateBothCalendars();
  updateDateDisplay();
  // Auto-apply presets immediately
  applyDateFilterFromPicker();
}

function applyDateFilterFromPicker() {
  if (!pickerFromDate || !pickerToDate) return;

  dateFilterFrom = pickerFromDate;
  dateFilterTo = pickerToDate;
  
  // Filter allTrades by account then date
  allTrades = allTradesUnfiltered.filter(t => {
    if (t.account !== selectedAccount) return false;
    if (dateFilterFrom && t.date < dateFilterFrom) return false;
    if (dateFilterTo && t.date > dateFilterTo) return false;
    return true;
  });
  
  // Rebuild dailyData from filtered trades
  dailyData = {};
  allTrades.forEach(t => {
    if (!dailyData[t.dateKey]) {
      dailyData[t.dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[t.dateKey].pnl += t.pnl;
    dailyData[t.dateKey].tradeCount += 1;
    if (t.pnl > 0) dailyData[t.dateKey].wins += 1;
    else if (t.pnl < 0) dailyData[t.dateKey].losses += 1;
    else dailyData[t.dateKey].breakeven += 1;
  });
  
  // Format: "Jan 2, 2026 → Feb 17, 2026"
  const fmt = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  const rangeText = `${fmt(dateFilterFrom)} → ${fmt(dateFilterTo)}`;
  document.getElementById('dateRangeText').textContent = rangeText;
  document.getElementById('clearFilterBtn').style.display = 'flex';

  // Navigate main calendar to start of range
  if (dateFilterFrom) {
    calendarMonth = dateFilterFrom.getMonth();
    calendarYear = dateFilterFrom.getFullYear();
  }
  
  closeDatePicker();
  renderAll();
}

function clearDateFilter() {
  pickerFromDate = null;
  pickerToDate = null;
  pickerSelectionPhase = 1;
  dateFilterFrom = null;
  dateFilterTo = null;
  allTrades = allTradesUnfiltered.filter(t => t.account === selectedAccount);
  
  // Rebuild dailyData from account trades
  dailyData = {};
  allTrades.forEach(t => {
    if (!dailyData[t.dateKey]) {
      dailyData[t.dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[t.dateKey].pnl += t.pnl;
    dailyData[t.dateKey].tradeCount += 1;
    if (t.pnl > 0) dailyData[t.dateKey].wins += 1;
    else if (t.pnl < 0) dailyData[t.dateKey].losses += 1;
    else dailyData[t.dateKey].breakeven += 1;
  });
  
  document.getElementById('dateRangeText').textContent = 'All time';
  document.getElementById('clearFilterBtn').style.display = 'none';
  closeDatePicker();
  renderAll();
}



// ============================================================
// LOAD & PARSE CSV
// ============================================================
// Account sheets configuration
const ACCOUNTS = [
  {
    name: "Breakout 100K",
    gvizUrl: 'https://docs.google.com/spreadsheets/d/1lr6NH8wkv0lZvuriRLG2nCSlg-VGH6D6JA5sxDE7Bus/gviz/tq?tqx=out:csv&gid=653744386',
    pubUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH3jFflZ0yd3k_owNsVgezKK00Z8HGehudo_5gqajVxvCqMCeCCwSwkDhx9484DVHY3z9hWMds2ime/pub?gid=653744386&single=true&output=csv'
  },
  {
    name: "Bybit main",
    gvizUrl: 'https://docs.google.com/spreadsheets/d/1lr6NH8wkv0lZvuriRLG2nCSlg-VGH6D6JA5sxDE7Bus/gviz/tq?tqx=out:csv&gid=759429748',
    pubUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQH3jFflZ0yd3k_owNsVgezKK00Z8HGehudo_5gqajVxvCqMCeCCwSwkDhx9484DVHY3z9hWMds2ime/pub?gid=759429748&single=true&output=csv'
  }
];

async function loadData() {
  const statusEl = document.getElementById('loadStatus');

  console.log('Starting data load...');

    // Destroy existing charts before re-rendering
    if (cumulativeChart) { cumulativeChart.destroy(); cumulativeChart = null; }
    if (dailyChart) { dailyChart.destroy(); dailyChart = null; }

  allTradesUnfiltered = [];
  availableAccounts = [];

  // Load each account sheet
  for (const account of ACCOUNTS) {
    console.log(`Loading ${account.name}...`);
    const urls = [account.pubUrl, account.gvizUrl];
    
    for (const url of urls) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const text = await res.text();
        if (text.length < 100) continue;
        
        console.log(`Parsing ${account.name}...`);
        const trades = parseAccountCSV(text, account.name);
        allTradesUnfiltered.push(...trades);
        availableAccounts.push(account.name);
        console.log(`Loaded ${trades.length} trades from ${account.name}`);
        break; // Success, move to next account
      } catch(e) {
        console.error(`Error loading ${account.name} from ${url}:`, e);
        continue;
      }
    }
  }

  if (allTradesUnfiltered.length === 0) {
    console.error('Failed to load from all accounts');
    statusEl.textContent = '⚠ Failed to load data';
    statusEl.style.color = 'var(--red)';
    return;
  }

  console.log(`Total trades loaded: ${allTradesUnfiltered.length}`);
  
  // Set up account dropdown
  populateAccountDropdown();
  
  // Filter by default account
  filterByAccount();
  
  console.log('Rendering...');
  renderAll();
  console.log('Done!');
  
  // Update load status with time
  const now = new Date();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  statusEl.textContent = `✓ Data loaded ${hours}:${minutes}`;
  statusEl.style.color = 'var(--green)';
  
  // Show calendar button
  document.getElementById('calendarBtnWrapper').style.display = 'flex';
  document.getElementById('calendarBtn').style.display = 'flex';
}

function populateAccountDropdown() {
  const optionsList = document.getElementById('accountOptionsList');
  optionsList.innerHTML = '';
  
  availableAccounts.forEach((account, index) => {
    const option = document.createElement('div');
    option.className = 'account-option';
    option.setAttribute('data-value', account);
    option.innerHTML = `
      <input type="checkbox" id="account-${index}" />
      <label for="account-${index}">${account}</label>
    `;
    option.onclick = () => selectAccount(account);
    optionsList.appendChild(option);
  });
  
  // Set first account as default
  if (availableAccounts.length > 0) {
    selectedAccount = availableAccounts[0];
    document.getElementById('selectedAccountText').textContent = selectedAccount;
    updateAccountCheckboxes();
    filterByAccount();
  }
}

function toggleAccountDropdown() {
  const dropdown = document.getElementById('accountDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function selectAccount(account) {
  selectedAccount = account;
  document.getElementById('selectedAccountText').textContent = account;
  updateAccountCheckboxes();
  toggleAccountDropdown();
  filterByAccount();
}

function updateAccountCheckboxes() {
  // Uncheck all
  availableAccounts.forEach((_, index) => {
    const checkbox = document.getElementById(`account-${index}`);
    if (checkbox) checkbox.checked = false;
  });
  
  // Check selected
  const index = availableAccounts.indexOf(selectedAccount);
  if (index >= 0) {
    const checkbox = document.getElementById(`account-${index}`);
    if (checkbox) checkbox.checked = true;
  }
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
  // Close account dropdown
  const wrapper = document.querySelector('.account-dropdown-wrapper');
  const dropdown = document.getElementById('accountDropdown');
  if (wrapper && dropdown && !wrapper.contains(e.target)) {
    dropdown.style.display = 'none';
  }
  // Close date picker (content div has stopPropagation so only outside clicks reach here)
  const dateModal = document.getElementById('datePickerModal');
  if (dateModal && dateModal.style.display !== 'none') {
    const calendarBtnWrapper = document.getElementById('calendarBtnWrapper');
    if (calendarBtnWrapper && !calendarBtnWrapper.contains(e.target)) {
      pickerSelectionPhase = 1;
      dateModal.style.display = 'none';
    }
  }
});

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += ch;
    }
  }
  result.push(current.trim());
  return result;
}

function parseAccountCSV(text, accountName) {
  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]);
  const trades = [];

  console.log('Headers:', headers);

  // Column structure:
  // ID, Open time, Close time, Ticker, Direction, Dollar risk, Net P&L, Percentage risk, Net ROI, R Multiple, Duration, Start Balance, Close Balance, Withdrawals, Notion
  
  const closeTimeIdx = headers.findIndex(h => h.toLowerCase().includes('close time'));
  const tickerIdx = headers.findIndex(h => h.toLowerCase().includes('ticker'));
  const directionIdx = headers.findIndex(h => h.toLowerCase().includes('direction'));
  const pnlIdx = headers.findIndex(h => h.toLowerCase().includes('net p&l'));
  const startBalanceIdx = headers.findIndex(h => h.toLowerCase().includes('start balance'));
  const closeBalanceIdx = headers.findIndex(h => h.toLowerCase().includes('close balance'));
  const dollarRiskIdx = headers.findIndex(h => h.toLowerCase().includes('dollar risk'));
  const percentageRiskIdx = headers.findIndex(h => h.toLowerCase().includes('percentage risk'));
  const roiIdx = headers.findIndex(h => h.toLowerCase().includes('net roi'));
  const rMultipleIdx = headers.findIndex(h => h.toLowerCase().includes('r multiple'));

  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    
    const closeTimeStr = cols[closeTimeIdx];
    const pnlStr = cols[pnlIdx];

    if (!closeTimeStr || !pnlStr) continue;

    // Parse PnL: handle negative values with $ and commas
    let pnlClean = pnlStr.replace(/[$\s]/g, '');
    pnlClean = pnlClean.replace(/,/g, '');
    const pnl = parseFloat(pnlClean);
    if (isNaN(pnl)) continue;

    // Parse close time: "21/01/26 23:03" format
    const date = parseDateTimeNew(closeTimeStr);
    if (!date) continue;

    const dateKey = formatDateKey(date);
    
    // Parse start and close balance
    const startBalanceStr = cols[startBalanceIdx];
    const closeBalanceStr = cols[closeBalanceIdx];
    let startBalance = 0, closeBalance = 0;
    
    if (startBalanceStr) {
      let clean = startBalanceStr.replace(/[$\s,]/g, '');
      startBalance = parseFloat(clean);
    }
    if (closeBalanceStr) {
      let clean = closeBalanceStr.replace(/[$\s,]/g, '');
      closeBalance = parseFloat(clean);
    }

    const trade = {
      date,
      dateKey,
      pnl,
      winLoss: pnl > 0 ? 'win' : pnl < 0 ? 'loss' : 'breakeven',
      ticker: cols[tickerIdx] || '',
      direction: cols[directionIdx] || '',
      account: accountName,
      startBalance,
      closeBalance,
      dollarRisk: cols[dollarRiskIdx] || '',
      percentageRisk: cols[percentageRiskIdx] || '',
      roi: cols[roiIdx] || '',
      rMultiple: cols[rMultipleIdx] || ''
    };
    
    trades.push(trade);
  }

  return trades;
}

// Parse new date format: "21/01/26 23:03" or "d/m/y h:mm"
function parseDateTimeNew(str) {
  if (!str) return null;
  str = str.trim().replace(/^"|"$/g, ''); // Remove surrounding quotes if any
  
  // New format: "January 21, 2026 22:27"
  const monthNames = {
    'january': 0, 'february': 1, 'march': 2, 'april': 3,
    'may': 4, 'june': 5, 'july': 6, 'august': 7,
    'september': 8, 'october': 9, 'november': 10, 'december': 11
  };
  
  // Try "January 21, 2026 22:27" format
  const longMatch = str.match(/^(\w+)\s+(\d+),\s+(\d{4})\s+(\d+):(\d+)/);
  if (longMatch) {
    const month = monthNames[longMatch[1].toLowerCase()];
    const day = parseInt(longMatch[2]);
    const year = parseInt(longMatch[3]);
    const hours = parseInt(longMatch[4]);
    const minutes = parseInt(longMatch[5]);
    if (month !== undefined) {
      return new Date(year, month, day, hours, minutes, 0, 0);
    }
  }
  
  // Fallback: "21/01/26 22:27" format
  const shortMatch = str.match(/^(\d+)\/(\d+)\/(\d+)\s+(\d+):(\d+)/);
  if (shortMatch) {
    const day = parseInt(shortMatch[1]);
    const month = parseInt(shortMatch[2]) - 1;
    const year = 2000 + parseInt(shortMatch[3]);
    const hours = parseInt(shortMatch[4]);
    const minutes = parseInt(shortMatch[5]);
    return new Date(year, month, day, hours, minutes, 0, 0);
  }
  
  return null;
}

// Keep old parseCSV for backwards compatibility (not used now)
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]);
  allTrades = [];
  allTradesUnfiltered = [];
  dailyData = {};

  // Find column indices
  // Expecting: Trade ID, Account, Open date, Open Time, Ticker, Direction, Win/Loss, % Risk, % PnL, R, PnL, Learnings
  const dateIdx = headers.findIndex(h => h.toLowerCase().includes('open date') || h.toLowerCase().includes('date'));
  const pnlIdx = headers.findIndex(h => h.toLowerCase() === 'pnl');
  const winlossIdx = headers.findIndex(h => h.toLowerCase().includes('win/loss'));
  const tickerIdx = headers.findIndex(h => h.toLowerCase().includes('ticker'));
  const directionIdx = headers.findIndex(h => h.toLowerCase().includes('direction'));
  const accountIdx = headers.findIndex(h => h.toLowerCase().includes('account'));

  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    const dateStr = cols[dateIdx];
    const pnlStr = cols[pnlIdx];

    if (!dateStr || !pnlStr) continue;

    // Parse PnL: US format only (comma = thousands separator, period = decimal)
    let pnlClean = pnlStr.replace(/[$\s]/g, ''); // Remove $ and spaces
    pnlClean = pnlClean.replace(/,/g, '');       // Remove commas (thousands separator)
    const pnl = parseFloat(pnlClean);
    if (isNaN(pnl)) continue;

    // Parse date: "21 jan 26" or similar
    const date = parseDate(dateStr);
    if (!date) continue;

    const dateKey = formatDateKey(date);
    const winLoss = cols[winlossIdx] ? cols[winlossIdx].toLowerCase() : '';
    const ticker = cols[tickerIdx] || '';
    const direction = cols[directionIdx] || '';

    const trade = { date, dateKey, pnl, winLoss, ticker, direction, account: cols[accountIdx] || 'Unknown' };
    allTrades.push(trade);
    allTradesUnfiltered.push(trade);

    if (!dailyData[dateKey]) {
      dailyData[dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[dateKey].pnl += pnl;
    dailyData[dateKey].tradeCount += 1;
    if (pnl > 0) dailyData[dateKey].wins += 1;
    else if (pnl < 0) dailyData[dateKey].losses += 1;
    else dailyData[dateKey].breakeven += 1;
  }
}

function parseDate(str) {
  // Handle "21 jan 26", "21 jan 2026", etc.
  const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
  const parts = str.trim().split(/[\s\/\-]+/);
  if (parts.length >= 3) {
    let day, month, year;
    // Try "21 jan 26"
    if (isNaN(parts[1]) && months[parts[1].toLowerCase()] !== undefined) {
      day = parseInt(parts[0]);
      month = months[parts[1].toLowerCase()];
      year = parseInt(parts[2]);
      if (year < 100) year += 2000;
    }
    // Try "jan 21 26" or other formats
    else if (isNaN(parts[0]) && months[parts[0].toLowerCase()] !== undefined) {
      month = months[parts[0].toLowerCase()];
      day = parseInt(parts[1]);
      year = parseInt(parts[2]);
      if (year < 100) year += 2000;
    }
    if (day && month !== undefined && year) {
      return new Date(year, month, day);
    }
  }
  // Fallback: try native parse
  const d = new Date(str);
  if (!isNaN(d.getTime())) return d;
  return null;
}

function formatDateKey(date) {
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function formatCurrency(val) {
  const abs = Math.abs(val);
  let str;
  if (abs >= 1000) str = '$' + (abs/1000).toFixed(1) + 'K';
  else str = '$' + abs.toFixed(2);
  return (val < 0 ? '-' : '') + str;
}

function formatCurrencyFull(val) {
  const sign = val < 0 ? '-' : '';
  const abs = Math.abs(val);
  return sign + '$' + abs.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}

// ============================================================
// RENDER ALL
// ============================================================
// ============================================================
// ============================================================
// CHART EXPAND
// ============================================================
let expandedChartInstance = null;

function expandChart(sourceCanvasId, title) {
  const sourceChart = Chart.getChart(sourceCanvasId);
  if (!sourceChart) return;

  document.getElementById('chartExpandTitle').textContent = title;
  document.getElementById('chartExpandOverlay').style.display = 'flex';

  // Destroy previous instance
  if (expandedChartInstance) {
    expandedChartInstance.destroy();
    expandedChartInstance = null;
  }

  // Replace the canvas element entirely to reset dimensions
  const wrapper = document.getElementById('expandedChart').parentElement;
  const oldCanvas = document.getElementById('expandedChart');
  oldCanvas.remove();
  const newCanvas = document.createElement('canvas');
  newCanvas.id = 'expandedChart';
  newCanvas.style.width = '100%';
  newCanvas.style.height = '400px';
  wrapper.appendChild(newCanvas);

  const cfg = sourceChart.config;
  expandedChartInstance = new Chart(newCanvas, {
    type: cfg.type,
    data: JSON.parse(JSON.stringify(cfg.data)),
    options: {
      ...JSON.parse(JSON.stringify(cfg.options)),
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
    },
    plugins: [crosshairPlugin],
  });
}

function closeChartExpand(event) {
  if (!event || event.target === document.getElementById('chartExpandOverlay')) {
    document.getElementById('chartExpandOverlay').style.display = 'none';
    if (expandedChartInstance) {
      expandedChartInstance.destroy();
      expandedChartInstance = null;
    }
  }
}

// ============================================================
// DAY POPUP
// ============================================================
function openDayPopup(dateKey, day) {
  const trades = allTrades.filter(t => t.dateKey === dateKey);
  if (!trades.length) return;

  const date = new Date(trades[0].date);
  const dateStr = date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  document.getElementById('dayPopupTitle').textContent = dateStr;

  const totalPnl = trades.reduce((s, t) => s + t.pnl, 0);
  const wins = trades.filter(t => t.pnl > 0).length;

  document.getElementById('dayPopupTrades').innerHTML = trades.map(t => {
    const pnlCls = t.pnl > 0 ? 'positive' : t.pnl < 0 ? 'negative' : '';
    const sign = t.pnl > 0 ? '+' : t.pnl < 0 ? '-' : '';
    const absVal = Math.abs(t.pnl).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
    const pnlStr = `${sign}$${absVal}`;
    const rVal = t.rMultiple !== undefined && t.rMultiple !== '' ? parseFloat(t.rMultiple) : null;
    const rStr = rVal !== null ? (rVal >= 0 ? '+' : '') + rVal.toFixed(1) + 'R' : '—';
    return `<tr>
      <td style="font-weight:700;color:var(--color-text)">${t.ticker}</td>
      <td style="color:var(--color-text)">${t.direction || '—'}</td>
      <td style="color:var(--color-text)">${t.roi || '—'}</td>
      <td style="color:var(--color-text)">${rStr}</td>
      <td class="${pnlCls}" style="font-weight:600">${pnlStr}</td>
    </tr>`;
  }).join('');

  const totalCls = totalPnl > 0 ? 'positive' : totalPnl < 0 ? 'negative' : '';
  const totalSign = totalPnl > 0 ? '+' : totalPnl < 0 ? '-' : '';
  const totalStr = `${totalSign}$${Math.abs(totalPnl).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
  const winRate = trades.length > 0 ? Math.round((wins / trades.length) * 100) : 0;
  document.getElementById('dayPopupFooter').innerHTML = `
    <span class="footer-label">${trades.length} trade${trades.length > 1 ? 's' : ''} · ${winRate}% win rate</span>
    <span class="footer-pnl ${totalCls}">${totalStr}</span>
  `;

  document.getElementById('dayPopupOverlay').style.display = 'flex';
}

function closeDayPopup(event) {
  if (!event || event.target === document.getElementById('dayPopupOverlay')) {
    document.getElementById('dayPopupOverlay').style.display = 'none';
  }
}

// ============================================================

function renderAll() {
  renderMetrics();
  renderCumulativeChart();
  renderDailyChart();
  renderCalendar();
}

function filterByAccount() {
  // Filter trades by account (selectedAccount is set by selectAccount function)
  if (selectedAccount === 'all') {
    allTrades = [...allTradesUnfiltered];
  } else {
    allTrades = allTradesUnfiltered.filter(t => t.account === selectedAccount);
  }
  
  // Apply date filter if exists
  if (dateFilterFrom || dateFilterTo) {
    allTrades = allTrades.filter(t => {
      if (dateFilterFrom && t.date < dateFilterFrom) return false;
      if (dateFilterTo && t.date > dateFilterTo) return false;
      return true;
    });
  }
  
  // Rebuild dailyData
  dailyData = {};
  allTrades.forEach(t => {
    if (!dailyData[t.dateKey]) {
      dailyData[t.dateKey] = { pnl: 0, tradeCount: 0, wins: 0, losses: 0, breakeven: 0 };
    }
    dailyData[t.dateKey].pnl += t.pnl;
    dailyData[t.dateKey].tradeCount += 1;
    if (t.pnl > 0) dailyData[t.dateKey].wins += 1;
    else if (t.pnl < 0) dailyData[t.dateKey].losses += 1;
    else dailyData[t.dateKey].breakeven += 1;
  });
  
  renderAll();
}

// ============================================================
// METRICS
// ============================================================
function renderMetrics() {
  // Net PnL
  const totalPnl = allTrades.reduce((s,t) => s + t.pnl, 0);
  const pnlEl = document.getElementById('val-pnl');
  pnlEl.textContent = formatCurrencyFull(totalPnl);
  pnlEl.className = 'value ' + (totalPnl >= 0 ? 'positive' : 'negative');
  
  // Net P&L percentage (relative to starting balance of selected period)
  const pnlPercentEl = document.getElementById('val-pnl-percent');
  if (allTrades.length > 0) {
    // Get starting balance from first trade in the filtered set
    const sortedTrades = [...allTrades].sort((a, b) => a.date - b.date);
    const firstTrade = sortedTrades[0];
    const startingBalance = firstTrade.startBalance;
    
    if (startingBalance > 0) {
      const pnlPercent = (totalPnl / startingBalance) * 100;
      pnlPercentEl.textContent = `${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%`;
      pnlPercentEl.style.color = pnlPercent >= 0 ? 'var(--green)' : 'var(--red)';
    } else {
      pnlPercentEl.textContent = '—';
    }
  } else {
    pnlPercentEl.textContent = '—';
  }

  // Win rate
  const wins = allTrades.filter(t => t.pnl > 0).length;
  const losses = allTrades.filter(t => t.pnl < 0).length;
  const breakeven = allTrades.filter(t => t.pnl === 0).length;
  const total = allTrades.length;
  const winRate = total > 0 ? (wins / total) * 100 : 0;

  document.getElementById('val-winrate').textContent = winRate.toFixed(2) + '%';
  document.getElementById('val-wins').textContent = wins;
  document.getElementById('val-losses').textContent = losses;
  document.getElementById('val-breakeven').textContent = breakeven;

  // Gauge - semicircle showing wins in green and losses in red
  const gaugeArc = document.getElementById('gauge-arc');
  const gaugeArcLoss = document.getElementById('gauge-arc-loss');
  const arcLength = 94.25; // Half circle arc length
  const lossRate = total > 0 ? (losses / total) * 100 : 0;
  
  // Green arc shows wins starting from left
  const winOffset = arcLength * (1 - winRate / 100);
  gaugeArc.style.strokeDashoffset = winOffset;
  
  // Red arc shows losses - needs to be offset to start after wins
  const lossLength = arcLength * (lossRate / 100);
  gaugeArcLoss.style.strokeDasharray = `${lossLength} ${arcLength}`;
  gaugeArcLoss.style.strokeDashoffset = -arcLength * (winRate / 100);

  // Profit Factor
  const grossProfit = allTrades.filter(t=>t.pnl>0).reduce((s,t)=>s+t.pnl,0);
  const grossLoss = Math.abs(allTrades.filter(t=>t.pnl<0).reduce((s,t)=>s+t.pnl,0));
  const pf = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? Infinity : 0);
  const pfEl = document.getElementById('val-pf');
  pfEl.textContent = pf === Infinity ? '∞' : pf.toFixed(2);
  pfEl.className = 'value ' + (pf >= 1 ? 'positive' : 'negative');

  // PF gauge (cap at 3 for visual)
  const pfGauge = document.getElementById('pf-gauge-circle');
  const pfCircumference = 176; // 2 * PI * 28 ≈ 176
  const pfPercent = Math.min(pf / 3, 1);
  pfGauge.style.strokeDashoffset = pfCircumference * (1 - pfPercent);
  pfGauge.style.stroke = pf >= 1 ? '#00c9a7' : '#ff4757';

  // Avg win / loss
  const avgWin = wins > 0 ? grossProfit / wins : 0;
  const avgLoss = losses > 0 ? grossLoss / losses : 0;
  const ratio = avgLoss > 0 ? avgWin / avgLoss : 0;
  
  document.getElementById('val-ratio').textContent = ratio > 0 ? ratio.toFixed(2) : '—';
  document.getElementById('label-avgwin').textContent = formatCurrency(avgWin);
  document.getElementById('label-avgloss').textContent = '-' + formatCurrency(avgLoss);

  // Avg bar ratio
  const winPart = document.querySelector('.avg-bar .win-part');
  const lossPart = document.querySelector('.avg-bar .loss-part');
  const total2 = avgWin + avgLoss;
  if (total2 > 0) {
    winPart.style.flex = (avgWin / total2);
    lossPart.style.flex = (avgLoss / total2);
  }
  
  // Account Balance - close balance of most recent trade in filtered period
  const currentBalanceEl = document.getElementById('val-current-balance');
  const accountTrades = allTradesUnfiltered.filter(t => t.account === selectedAccount);
  
  if (accountTrades.length > 0) {
    // Most recent trade overall (for actual current balance)
    const allSorted = [...accountTrades].sort((a, b) => b.date - a.date);
    const currentBalance = allSorted[0].closeBalance;
    
    // Balance at start of filtered period (for color comparison)
    let balanceAtPeriodStart;
    if (allTrades.length > 0) {
      const filteredSorted = [...allTrades].sort((a, b) => a.date - b.date);
      balanceAtPeriodStart = filteredSorted[0].startBalance;
      // If date filter active, show close balance of last trade in period
      if (dateFilterFrom || dateFilterTo) {
        const lastInPeriod = [...allTrades].sort((a, b) => b.date - a.date)[0];
        currentBalanceEl.textContent = formatCurrencyFull(lastInPeriod.closeBalance);
        currentBalanceEl.className = 'value ' + (lastInPeriod.closeBalance >= balanceAtPeriodStart ? 'positive' : 'negative');
      } else {
        currentBalanceEl.textContent = formatCurrencyFull(currentBalance);
        currentBalanceEl.className = 'value ' + (currentBalance >= filteredSorted[0].startBalance ? 'positive' : 'negative');
      }
    } else {
      currentBalanceEl.textContent = formatCurrencyFull(currentBalance);
      currentBalanceEl.className = 'value';
    }
  } else {
    currentBalanceEl.textContent = '—';
    currentBalanceEl.className = 'value';
  }

}

// ============================================================
// CUMULATIVE CHART
// ============================================================

// Crosshair plugin for vertical line on hover
const crosshairPlugin = {
  id: 'crosshair',
  afterDraw: (chart) => {
    if (chart.tooltip?._active?.length) {
      const ctx = chart.ctx;
      const activePoint = chart.tooltip._active[0];
      const x = activePoint.element.x;
      const topY = chart.scales.y.top;
      const bottomY = chart.scales.y.bottom;
      
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(x, topY);
      ctx.lineTo(x, bottomY);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(142, 142, 142, 0.3)';
      ctx.setLineDash([5, 5]);
      ctx.stroke();
      ctx.restore();
    }
  }
};

function renderCumulativeChart() {
  // Build sorted daily timeline
  const keys = Object.keys(dailyData).sort();
  if (keys.length === 0) return;

  const labels = [];
  const values = [];
  let cumulative = 0;

  // Generate all dates from first trade to last trade
  const start = new Date(keys[0]);
  const end = new Date(keys[keys.length-1]);
  
  // Add starting point at 0 (day before first trade)
  const dayBeforeStart = new Date(start);
  dayBeforeStart.setDate(dayBeforeStart.getDate() - 1);
  labels.push(dayBeforeStart.getDate() + '/' + (dayBeforeStart.getMonth()+1) + '/' + String(dayBeforeStart.getFullYear()).slice(-2));
  values.push(0);
  
  const d = new Date(start);
  while (d <= end) {
    const key = formatDateKey(d);
    if (dailyData[key]) cumulative += dailyData[key].pnl;
    labels.push(d.getDate() + '/' + (d.getMonth()+1) + '/' + String(d.getFullYear()).slice(-2));
    values.push(cumulative);
    d.setDate(d.getDate()+1);
  }

  const ctx = document.getElementById('cumulativeChart').getContext('2d');
  if (cumulativeChart) cumulativeChart.destroy();

  cumulativeChart = new Chart(ctx, {
    type: 'line',
    plugins: [crosshairPlugin],
    data: {
      labels: labels,
      datasets: [{
        data: values,
        borderColor: 'rgba(142, 142, 142, 0.8)',
        borderWidth: 2,
        pointRadius: 2,
        pointBackgroundColor: 'rgba(142, 142, 142, 0.8)',
        pointBorderColor: 'rgba(142, 142, 142, 0.8)',
        pointHoverRadius: 4,
        pointHoverBackgroundColor: 'rgba(142, 142, 142, 1)',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 2,
        fill: true,
        backgroundColor: function(context) {
          const chart = context.chart;
          const {ctx: c, chartArea} = chart;
          if (!chartArea) return 'transparent';
          const gradient = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
          gradient.addColorStop(0, 'rgba(142, 142, 142, 0.15)');
          gradient.addColorStop(1, 'rgba(142, 142, 142, 0.0)');
          return gradient;
        },
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: { legend: { display: false }, tooltip: {
        backgroundColor: '#1a2230',
        titleColor: '#6b7a8d',
        bodyColor: '#eef0f2',
        borderColor: '#1e252e',
        borderWidth: 1,
        titleFont: { family: 'Manrope', size: 11 },
        bodyFont: { family: 'Manrope', size: 13, weight: '600' },
        callbacks: {
          title: function(items) { return items[0].label; },
          label: function(item) { return ' ' + formatCurrencyFull(item.parsed.y); }
        }
      }},
      scales: {
        x: {
          ticks: { color: '#8e8e8e', maxTicksLimit: 8, font: { family: 'Manrope', size: 14 }, maxRotation: 45 },
          grid: { color: 'rgba(30,37,46,0.5)' },
          border: { color: '#1e252e' }
        },
        y: {
          ticks: { color: '#8e8e8e', font: { family: 'Manrope', size: 14 }, callback: v => formatCurrency(v) },
          grid: { color: 'rgba(30,37,46,0.5)' },
          border: { color: '#1e252e' },
          grace: '10%'
        }
      }
    }
  });
}

// ============================================================
// DAILY PNL CHART
// ============================================================
function renderDailyChart() {
  const keys = Object.keys(dailyData).sort();
  if (keys.length === 0) return;

  const labels = keys.map(k => { const p = k.split('-'); return p[2] + '/' + p[1].replace(/^0/,'') + '/' + p[0].slice(-2); });
  const values = keys.map(k => dailyData[k].pnl);
  const colors = values.map(v => v >= 0 ? '#00c9a7' : '#ff4757');

  const ctx = document.getElementById('dailyChart').getContext('2d');
  if (dailyChart) dailyChart.destroy();

  dailyChart = new Chart(ctx, {
    type: 'bar',
    plugins: [crosshairPlugin],
    data: {
      labels: labels,
      datasets: [
        { data: values, backgroundColor: colors, borderRadius: 2 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1a2230',
          titleColor: '#6b7a8d',
          bodyColor: '#eef0f2',
          borderColor: '#1e252e',
          borderWidth: 1,
          titleFont: { family: 'Manrope', size: 11 },
          bodyFont: { family: 'Manrope', size: 13, weight: '600' },
          callbacks: {
            title: function(items) { return items[0].label; },
            label: function(item) { return ' ' + formatCurrencyFull(item.parsed.y || 0); }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#8e8e8e', maxTicksLimit: 8, font: { family: 'Manrope', size: 14 }, maxRotation: 45 },
          grid: { display: false },
          border: { color: '#1e252e' }
        },
        y: {
          ticks: { color: '#8e8e8e', font: { family: 'Manrope', size: 14 }, callback: v => formatCurrency(v) },
          grid: { color: 'rgba(30,37,46,0.5)' },
          border: { color: '#1e252e' },
          grace: '10%'
        }
      }
    }
  });
}

// ============================================================
// CALENDAR
// ============================================================
function renderCalendar() {
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('cal-month-title').textContent = monthNames[calendarMonth] + ' ' + calendarYear;

  const grid = document.getElementById('calendarGrid');
  const sidebar = document.getElementById('weeklySidebar');
  grid.innerHTML = '';
  sidebar.innerHTML = '';

  // First day of month (Mon=0 system)
  let startDow = new Date(calendarYear, calendarMonth, 1).getDay();
  startDow = startDow === 0 ? 6 : startDow - 1;

  const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
  const today = new Date();

  // Monthly P&L totals
  let monthlyPnl = 0, tradingDays = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    const key = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (dailyData[key]) { monthlyPnl += dailyData[key].pnl; tradingDays++; }
  }
  const mpnlEl = document.getElementById('cal-monthly-pnl');
  mpnlEl.textContent = formatCurrency(monthlyPnl);
  mpnlEl.className = 'ms-pnl ' + (monthlyPnl >= 0 ? 'positive' : 'negative');
  document.getElementById('cal-trading-days').textContent = tradingDays + ' days';

  // Day headers
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => {
    const h = document.createElement('div');
    h.className = 'cal-header';
    h.textContent = d;
    grid.appendChild(h);
  });

  // Calculate total rows needed
  const totalCells = startDow + daysInMonth;
  const totalRows = Math.ceil(totalCells / 7);

  // Invisible header spacer in sidebar
  const hSpacer = document.createElement('div');
  hSpacer.className = 'cal-header';
  hSpacer.style.visibility = 'hidden';
  sidebar.appendChild(hSpacer);

  // Build week data
  const weeks = [];
  let currentWeek = { pnl: 0, tradingDays: 0 };
  let dayOfWeek = startDow;

  // Empty cells before first day
  for (let i = 0; i < startDow; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day empty';
    grid.appendChild(empty);
  }

  // Day cells
  for (let d = 1; d <= daysInMonth; d++) {
    const key = `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const data = dailyData[key];
    const isToday = (d === today.getDate() && calendarMonth === today.getMonth() && calendarYear === today.getFullYear());

    const cell = document.createElement('div');
    cell.className = 'cal-day';
    if (isToday) cell.classList.add('today');

    if (data) {
      cell.classList.add(data.pnl >= 0 ? 'positive' : 'negative');
      currentWeek.pnl += data.pnl;
      currentWeek.tradingDays++;
      cell.innerHTML = `
        <div class="day-num">${d}</div>
        <div class="day-pnl ${data.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(data.pnl)}</div>
        <div class="day-meta">${data.tradeCount} trade${data.tradeCount > 1 ? 's' : ''}<br>${data.tradeCount > 0 ? Math.round((data.wins/data.tradeCount)*100) : 0}%</div>
      `;
      cell.style.cursor = 'pointer';
      cell.addEventListener('click', () => openDayPopup(key, d));
    } else {
      cell.innerHTML = `<div class="day-num">${d}</div>`;
    }
    grid.appendChild(cell);

    // End of week (Sunday = col 6 in Mon=0) or last day of month
    if (dayOfWeek === 6 || d === daysInMonth) {
      weeks.push({...currentWeek});
      currentWeek = { pnl: 0, tradingDays: 0 };
    }
    dayOfWeek = (dayOfWeek + 1) % 7;
  }

  // Fill trailing empty cells to complete last row
  const trailingEmpties = (7 - ((startDow + daysInMonth) % 7)) % 7;
  for (let i = 0; i < trailingEmpties; i++) {
    const empty = document.createElement('div');
    empty.className = 'cal-day empty';
    grid.appendChild(empty);
  }

  // Render sidebar week items — one per row, using flex to match grid row heights
  // We use flex-grow on each item inside a flex-column sidebar
  sidebar.style.display = 'flex';
  sidebar.style.flexDirection = 'column';
  sidebar.style.gap = '4px';

  for (let i = 0; i < totalRows; i++) {
    const week = weeks[i] || { pnl: 0, tradingDays: 0 };
    const item = document.createElement('div');
    item.className = 'week-item';
    item.style.flex = '1';
    item.style.minHeight = '0';
    const pnlClass = week.pnl === 0 ? 'neutral' : (week.pnl >= 0 ? 'positive' : 'negative');
    item.innerHTML = `
      <div class="week-label">Week ${i+1}</div>
      <div class="week-pnl ${pnlClass}">${formatCurrency(week.pnl)}</div>
      <div class="week-days">${week.tradingDays} days</div>
    `;
    sidebar.appendChild(item);
  }
}

function changeMonth(dir) {
  calendarMonth += dir;
  if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
  if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
  renderCalendar();
}

function goToThisMonth() {
  calendarMonth = new Date().getMonth();
  calendarYear = new Date().getFullYear();
  renderCalendar();
}

// Initialize - load data after all functions are defined
loadData();
</script>
</div> <!-- Close main-content -->
</div> <!-- Close flex wrapper -->
</div> <!-- Close container -->
</body>
</html>
